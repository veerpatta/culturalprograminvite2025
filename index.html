<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Timetable Command Center - Veer Patta Public School</title>
	<meta name="theme-color" content="#2563eb">

	<!-- LIBRARIES (CDN) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>

	<!-- FONTS -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

	<!-- STYLES -->
	<style>
		/* CSS Variables for Theme */
		:root {
			--primary-50: #eff6ff;
			--primary-100: #dbeafe;
			--primary-200: #bfdbfe;
			--primary-300: #93c5fd;
			--primary-400: #60a5fa;
			--primary-500: #3b82f6;
			--primary-600: #2563eb;
			--primary-700: #1d4ed8;
			--primary-800: #1e40af;
			--primary-900: #1e3a8a;

			--gray-50: #f9fafb;
			--gray-100: #f3f4f6;
			--gray-200: #e5e7eb;
			--gray-300: #d1d5db;
			--gray-400: #9ca3af;
			--gray-500: #6b7280;
			--gray-600: #4b5563;
			--gray-700: #374151;
			--gray-800: #1f2937;
			--gray-900: #111827;

			--green-500: #10b981;
			--yellow-500: #f59e0b;
			--red-500: #ef4444;
			--red-600: #dc2626;

			--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
			--shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
			--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
			--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
			--shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

			--radius: 0.5rem;
			--radius-lg: 0.75rem;
		}

		/* Global Styles */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Inter', system-ui, -apple-system, sans-serif;
			background: linear-gradient(135deg, var(--primary-50) 0%, var(--gray-50) 100%);
			color: var(--gray-900);
			min-height: 100vh;
			line-height: 1.6;
		}

		/* Loading Screen */
		#loader {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: white;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 9999;
			transition: opacity 0.3s ease;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid var(--gray-200);
			border-top-color: var(--primary-600);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		/* App Container */
		.app-container {
			max-width: 1400px;
			margin: 0 auto;
			padding: 1rem;
		}

		/* Header */
		header {
			background: white;
			border-radius: var(--radius-lg);
			padding: 1.5rem;
			margin-bottom: 1.5rem;
			box-shadow: var(--shadow-md);
			text-align: center;
		}

		header h1 {
			font-size: 1.875rem;
			font-weight: 800;
			color: var(--primary-800);
			margin-bottom: 0.25rem;
		}

		header p {
			color: var(--gray-600);
			font-size: 0.875rem;
		}

		/* Navigation */
		nav {
			background: white;
			border-radius: var(--radius-lg);
			padding: 0.75rem;
			margin-bottom: 1.5rem;
			box-shadow: var(--shadow);
			display: flex;
			gap: 0.5rem;
			overflow-x: auto;
			scrollbar-width: thin;
		}

		nav::-webkit-scrollbar {
			height: 6px;
		}

		nav::-webkit-scrollbar-thumb {
			background: var(--gray-300);
			border-radius: 3px;
		}

		.nav-button {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.625rem 1rem;
			background: transparent;
			border: 1px solid var(--gray-200);
			border-radius: var(--radius);
			color: var(--gray-700);
			font-size: 0.875rem;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s;
			white-space: nowrap;
			flex-shrink: 0;
		}

		.nav-button:hover {
			background: var(--primary-50);
			border-color: var(--primary-300);
			color: var(--primary-700);
			transform: translateY(-1px);
		}

		.nav-button.active {
			background: var(--primary-600);
			border-color: var(--primary-600);
			color: white;
			box-shadow: var(--shadow-md);
		}

		.nav-button svg {
			width: 18px;
			height: 18px;
		}

		/* Main Content */
		.main-content {
			animation: fadeIn 0.3s ease;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Cards */
		.card {
			background: white;
			border-radius: var(--radius-lg);
			padding: 1.5rem;
			box-shadow: var(--shadow);
			margin-bottom: 1.5rem;
		}

		/* Stat Cards */
		.stat-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 1rem;
			margin-bottom: 1.5rem;
		}

		.stat-card {
			display: flex;
			align-items: center;
			gap: 1rem;
			padding: 1.25rem;
			background: white;
			border-radius: var(--radius-lg);
			box-shadow: var(--shadow);
			transition: transform 0.2s, box-shadow 0.2s;
		}

		.stat-card:hover {
			transform: translateY(-2px);
			box-shadow: var(--shadow-lg);
		}

		.stat-card-icon {
			width: 50px;
			height: 50px;
			border-radius: var(--radius);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			flex-shrink: 0;
		}

		.stat-card-icon svg {
			width: 24px;
			height: 24px;
		}

		.stat-card-label {
			font-size: 0.75rem;
			color: var(--gray-500);
			text-transform: uppercase;
			letter-spacing: 0.05em;
		}

		.stat-card-value {
			font-size: 1.5rem;
			font-weight: 700;
			color: var(--gray-900);
		}

		/* Tables */
		.table-container {
			overflow-x: auto;
			margin: 1rem -0.5rem;
			padding: 0 0.5rem;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			font-size: 0.875rem;
		}

		th {
			background: var(--gray-50);
			color: var(--gray-700);
			font-weight: 600;
			text-align: left;
			padding: 0.75rem;
			border-bottom: 2px solid var(--gray-200);
			position: sticky;
			top: 0;
			z-index: 10;
		}

		td {
			padding: 0.75rem;
			border-bottom: 1px solid var(--gray-100);
			vertical-align: top;
		}

		tr:hover {
			background: var(--primary-50);
		}

		.subject {
			font-weight: 600;
			color: var(--gray-900);
			margin-bottom: 0.125rem;
		}

		.teacher {
			font-size: 0.75rem;
			color: var(--gray-600);
		}

		.substitute {
			color: var(--primary-600);
			font-weight: 500;
		}

		.line-through {
			text-decoration: line-through;
			opacity: 0.5;
		}

		.class-name {
			font-size: 0.75rem;
			color: var(--gray-500);
			margin-top: 0.125rem;
		}

		/* Form Elements */
		select {
			width: 100%;
			padding: 0.625rem 0.75rem;
			border: 1px solid var(--gray-300);
			border-radius: var(--radius);
			background: white;
			font-size: 0.875rem;
			color: var(--gray-700);
			cursor: pointer;
			transition: border-color 0.2s;
		}

		select:hover {
			border-color: var(--primary-400);
		}

		select:focus {
			outline: none;
			border-color: var(--primary-500);
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
		}

		/* Buttons */
		.button {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			padding: 0.625rem 1.25rem;
			border-radius: var(--radius);
			font-size: 0.875rem;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s;
			border: none;
			width: 100%;
		}

		.button svg {
			width: 18px;
			height: 18px;
		}

		.button-primary {
			background: var(--primary-600);
			color: white;
		}

		.button-primary:hover {
			background: var(--primary-700);
			transform: translateY(-1px);
			box-shadow: var(--shadow-md);
		}

		.button-secondary {
			background: var(--gray-100);
			color: var(--gray-700);
			border: 1px solid var(--gray-300);
		}

		.button-secondary:hover {
			background: var(--gray-200);
			transform: translateY(-1px);
		}

		.button-danger {
			background: var(--red-500);
			color: white;
		}

		.button-danger:hover {
			background: var(--red-600);
			transform: translateY(-1px);
			box-shadow: var(--shadow-md);
		}

		.button-whatsapp {
			background: #25D366;
			color: white;
		}

		.button-whatsapp:hover {
			background: #1DA851;
			transform: translateY(-1px);
			box-shadow: var(--shadow-md);
		}

		/* Footer */
		footer {
			text-align: center;
			padding: 2rem 1rem;
			color: var(--gray-600);
			font-size: 0.875rem;
		}

		/* Mobile Menu Button */
		.mobile-menu-btn {
			display: none;
			position: fixed;
			bottom: 1rem;
			right: 1rem;
			width: 56px;
			height: 56px;
			border-radius: 50%;
			background: var(--primary-600);
			color: white;
			border: none;
			box-shadow: var(--shadow-lg);
			z-index: 100;
			cursor: pointer;
			transition: all 0.3s;
		}

		.mobile-menu-btn:hover {
			transform: scale(1.1);
			background: var(--primary-700);
		}

		.mobile-menu-btn svg {
			width: 24px;
			height: 24px;
		}

		/* Utility Classes */
		.grid {
			display: grid;
		}

		.grid-cols-1 {
			grid-template-columns: repeat(1, minmax(0, 1fr));
		}

		.gap-4 {
			gap: 1rem;
		}

		.gap-6 {
			gap: 1.5rem;
		}

		.mb-4 {
			margin-bottom: 1rem;
		}

		.mt-4 {
			margin-top: 1rem;
		}

		.flex {
			display: flex;
		}

		.flex-wrap {
			flex-wrap: wrap;
		}

		.items-center {
			align-items: center;
		}

		.justify-between {
			justify-content: space-between;
		}

		.justify-center {
			justify-content: center;
		}

		.font-bold {
			font-weight: 700;
		}

		.block {
			display: block;
		}

		/* Print Styles */
		@media print {
			body {
				background: white;
				font-size: 9pt !important;
			}
			.no-print {
				display: none !important;
			}
			.app-container {
				max-width: 100%;
				padding: 0;
			}
			.card {
				box-shadow: none;
				border: 1px solid var(--gray-300);
				page-break-inside: avoid;
				margin-bottom: 0.5rem;
				padding: 0.5rem;
			}
			table {
				font-size: 7pt !important;
				width: 100% !important;
			}
			th, td {
				padding: 2px 4px !important;
				font-size: 7pt !important;
				line-height: 1.1 !important;
			}
			th {
				background: #f5f5f5 !important;
				font-weight: bold;
			}
			.subject {
				font-size: 7pt !important;
				font-weight: bold;
				margin-bottom: 1px;
			}
			.teacher {
				font-size: 6pt !important;
				line-height: 1 !important;
			}
			.substitute {
				font-size: 6pt !important;
			}
			#print-capture-area {
				display: block !important;
				position: static !important;
				left: auto !important;
				width: 100% !important;
				max-width: none !important;
				padding: 0.5rem !important;
			}
			#print-header {
				text-align: center;
				margin-bottom: 0.5rem;
			}
			#print-header h1 {
				font-size: 14pt !important;
				margin: 0;
			}
			#print-header-subtitle {
				font-size: 12pt !important;
				margin: 0.25rem 0;
			}
			.table-container {
				margin: 0 !important;
				padding: 0 !important;
			}
			* {
				page-break-inside: avoid !important;
			}
			.card {
				page-break-before: avoid !important;
				page-break-after: avoid !important;
			}
		}

		/* Mobile responsive table: stack rows into cards with labels */
		@media (max-width: 768px) {
			table.responsive {
				border: 0;
			}
			table.responsive thead {
				display: none;
			}
			table.responsive tr {
				display: block;
				margin: 0 0 1rem 0;
				border: 1px solid var(--gray-200);
				border-radius: var(--radius);
				box-shadow: var(--shadow-sm);
				background: white;
				overflow: hidden;
			}
			table.responsive td {
				display: block;
				width: 100%;
				border: 0;
				border-bottom: 1px solid var(--gray-100);
				padding: 0.75rem;
				position: relative;
			}
			table.responsive td:last-child {
				border-bottom: 0;
			}
			table.responsive td::before {
				content: attr(data-label);
				display: block;
				font-size: 0.75rem;
				color: var(--gray-500);
				text-transform: uppercase;
				letter-spacing: 0.05em;
				margin-bottom: 0.5rem;
				font-weight: 600;
			}

			.app-container {
				padding: 0.5rem;
			}

			header {
				padding: 1rem;
				margin-bottom: 1rem;
			}

			header h1 {
				font-size: 1.5rem;
			}

			.card {
				padding: 1rem;
				margin-bottom: 1rem;
			}

			.stat-grid {
				grid-template-columns: repeat(2, 1fr);
				gap: 0.5rem;
			}

			.stat-card {
				padding: 0.75rem;
				flex-direction: column;
				text-align: center;
				gap: 0.5rem;
			}

			.stat-card-icon {
				width: 40px;
				height: 40px;
			}

			.stat-card-value {
				font-size: 1.25rem;
			}

			/* Navigation improvements */
			nav {
				padding: 0.5rem;
				gap: 0.25rem;
			}

			.nav-button {
				min-height: 44px;
				padding: 0.5rem 0.75rem;
				font-size: 0.75rem;
			}

			.nav-button span {
				display: none;
			}

			/* Button improvements */
			.button {
				padding: 0.75rem 1rem;
				font-size: 0.875rem;
				min-height: 44px;
			}

			/* Mobile responsive table: stack rows into cards with labels */
			table.responsive {
				border: 0;
			}

			table.responsive thead {
				display: none;
			}

			table.responsive tr {
				display: block;
				margin: 0 0 1rem 0;
				border: 1px solid var(--gray-200);
				border-radius: var(--radius);
				box-shadow: var(--shadow-sm);
				background: white;
				overflow: hidden;
			}

			table.responsive td {
				display: block;
				width: 100%;
				border: 0;
				border-bottom: 1px solid var(--gray-100);
				padding: 0.75rem;
				position: relative;
			}

			table.responsive td:last-child {
				border-bottom: 0;
			}

			table.responsive td::before {
				content: attr(data-label);
				display: block;
				font-size: 0.75rem;
				color: var(--gray-500);
				text-transform: uppercase;
				letter-spacing: 0.05em;
				margin-bottom: 0.5rem;
				font-weight: 600;
			}

			/* Improve grid layout on mobile */
			.grid-cols-md-2 {
				grid-template-columns: 1fr;
			}

			/* Mobile menu visibility */
			.mobile-menu-btn {
				display: flex;
				align-items: center;
				justify-content: center;
			}

			/* Free teacher finder mobile layout */
			#free-teacher-finder-container .grid {
				grid-template-columns: 1fr;
				gap: 0.75rem;
			}

			/* Substitution view mobile improvements */
			.card .grid {
				grid-template-columns: 1fr;
				gap: 1rem;
			}
		}

		@media (max-width: 480px) {
			.stat-grid {
				grid-template-columns: 1fr;
			}

			header h1 {
				font-size: 1.25rem;
			}

			.nav-button {
				padding: 0.5rem;
			}

			.nav-button svg {
				width: 16px;
				height: 16px;
			}
		}

		/* Enhanced mobile responsive design */
		@media (max-width: 768px) {
			/* ...existing code... */

			/* Better mobile stats layout */
			.stat-grid {
				grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
				gap: 0.75rem;
			}

			.stat-card {
				padding: 1rem;
				flex-direction: row;
				text-align: left;
				gap: 0.75rem;
			}

			.stat-card-icon {
				width: 35px;
				height: 35px;
				flex-shrink: 0;
			}

			.stat-card-value {
				font-size: 1.125rem;
			}

			/* Enhanced free teacher finder */
			#free-teacher-finder-container .grid {
				grid-template-columns: 1fr;
				gap: 0.5rem;
			}

			#free-teacher-finder-container select {
				font-size: 0.875rem;
				padding: 0.5rem;
			}

			/* Better mobile navigation */
			.nav-button {
				min-height: 48px;
				padding: 0.75rem;
				border-radius: var(--radius-lg);
			}

			.nav-button svg {
				width: 20px;
				height: 20px;
			}

			/* Enhanced table mobile view */
			table.responsive tr {
				margin: 0 0 1rem 0;
				padding: 0;
			}

			table.responsive td {
				padding: 0.875rem;
				position: relative;
			}

			table.responsive td::before {
				font-weight: 700;
				color: var(--primary-600);
				font-size: 0.8rem;
			}

			/* Better touch targets */
			button, select, input[type="checkbox"] {
				min-height: 44px;
			}

			input[type="checkbox"] {
				width: 18px;
				height: 18px;
				margin-right: 0.5rem;
			}
		}

		/* Enhanced loading states */
		.loading-state {
			opacity: 0.6;
			pointer-events: none;
		}

		.pulse {
			animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
		}

		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: .5; }
		}

		/* Better focus states for accessibility */
		:focus-visible {
			outline: 2px solid var(--primary-500);
			outline-offset: 2px;
			border-radius: var(--radius);
		}

		/* Enhanced toast */
		.toast {
			backdrop-filter: blur(8px);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}

		/* Performance optimizations */
		.card, .stat-card {
			will-change: transform;
			transform: translateZ(0);
		}
	</style>
</head>
<body>
	<div id="loader">
		<div class="spinner"></div>
	</div>

	<div id="print-capture-area" style="display: none; background: white; padding: 1.5rem;">
		<div id="print-header">
			<img src="logo.png" alt="Veer Patta Public School Logo" crossorigin="anonymous">
			<h1 id="print-header-title">Veer Patta Public School - Timetable</h1>
		</div>
		<h2 id="print-header-subtitle"></h2>
		<div id="print-content"></div>
	</div>

	<div class="app-container">
		<header class="no-print">
			<h1>📚 Timetable Command Center</h1>
			<p>Veer Patta Public School, Amet</p>
		</header>

		<nav class="no-print" id="main-nav">
			<button id="nav-Dashboard" class="nav-button active" onclick="switchView('Dashboard')">
				<i data-lucide="layout-dashboard"></i>
				<span>Dashboard</span>
			</button>
			<button id="nav-Day" class="nav-button" onclick="switchView('Day')">
				<i data-lucide="calendar-days"></i>
				<span>Day View</span>
			</button>
			<button id="nav-Substitution" class="nav-button" onclick="switchView('Substitution')">
				<i data-lucide="user-cog"></i>
				<span>Substitutions</span>
			</button>
			<button id="nav-Class" class="nav-button" onclick="switchView('Class')">
				<i data-lucide="school"></i>
				<span>Class View</span>
			</button>
			<button id="nav-Teacher" class="nav-button" onclick="switchView('Teacher')">
				<i data-lucide="users"></i>
				<span>Teacher View</span>
			</button>
		</nav>

		<main id="main-content" class="main-content"></main>

		<footer class="no-print">
			<p>© 2025 Veer Patta Public School | Developed with ❤️</p>
		</footer>
	</div>

	<!-- Mobile Quick Access Button -->
	<button class="mobile-menu-btn no-print" onclick="scrollToTop()">
		<i data-lucide="arrow-up"></i>
	</button>

	<script>
		// --- ENHANCED DATA STORE ---
		const rawData = `Monday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,EVS (Bindu),EVS (Bindu),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Hindi (Bindu),Home Work (Anjana),Maths (Kusum)
		Class 2,Maths (Anita),Maths (Anita),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),Hindi (Bindu),Hindi (Bindu)
		Class 3,EVS (Rashmita),EVS (Rashmita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Hindi (Kusum),Hindi (Kusum),Sports (Rakesh)
		Class 4,Hindi (Kusum),Home Work (Jainendra),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),EVS (Anita),EVS (Anita),Sports (Rakesh)
		Class 5,Maths (Nidhika),Hindi (Kusum),ELGA (Anita),ELGA (Anita),ELGA (Anita),CCS (Maya),Maths (Nidhika),EVS (Nidhika)
		Class 6,Science (Hemlata),Science (Hemlata),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),SST (Rashmita),Hindi (Jainendra)
		Class 7,Hindi (Jainendra),Maths (Leena),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Prakash),Maths (Leena),Science (Hemlata)
		Class 8,Hindi (Antima),CCS (Maya),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Science (Hemlata),Sanskrit (Antima)
		Class 9,Maths (Leena),SST (Pradhyuman),Science (Toshit),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra),English (Harshita),Maths (Leena)
		Class 10,SST (Pradhyuman),Hindi (Antima),Maths (Nathulal),Maths (Nathulal),Sanskrit (Antima),English (Harshita),Science (Toshit),Sports (Rakesh)
		Class 11 Science,Physics (Phy),Physics (Phy),Biology (Hemlata),English (Pradhyuman),Chemistry (Toshit),Chemistry (Toshit),English (Pradhyuman),Sports (Rakesh)
		Class 11 Commerce,Self Study (Maya),Business (Nidhika),Economics (Prakash),English (Pradhyuman),Accountancy (Nathulal),Accountancy (Nathulal),English (Pradhyuman),Accountancy (Nathulal)
		Class 11 Arts,English Literature (Harshita),Geography (Prakash),Economics (Prakash),English (Pradhyuman),CCS (Maya),Sports (Rakesh),English (Pradhyuman),Political Science (Pradhyuman)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy),Physics (Phy),English (Pradhyuman),Biology (Hemlata),Hindi (Jainendra),Physics (Phy)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Business (Pradhyuman),Economics (Prakash),English (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),CCS (Maya)
		Class 12 Arts,Geography (Prakash),English Literature (Harshita),Hindi Boards (Antima),Economics (Prakash),English (Pradhyuman),Political Science (Pradhyuman),Hindi (Jainendra),English Literature (Harshita)

		Tuesday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,EVS (Bindu),Maths (Kusum),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Hindi (Bindu),Hindi (Bindu),Home Work (Anjana)
		Class 2,Maths (Anita),Hindi (Bindu),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),EVS (Rashmita),Hindi (Bindu)
		Class 3,EVS (Rashmita),Maths (Anita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Maths (Anita),Hindi (Kusum),Hindi (Kusum)
		Class 4,Hindi (Kusum),Maths (Leena),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),Basic Hindi (Anjana),EVS (Anita),EVS (Anita)
		Class 5,EVS (Nidhika),Home Work (Rashmita),ELGA (Anita),ELGA (Anita),ELGA (Anita),Hindi (Kusum),Maths (Nidhika),EVS (Nidhika)
		Class 6,Science (Hemlata),Sanskrit (Jainendra),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),Hindi (Jainendra),SST (Rashmita)
		Class 7,Hindi (Jainendra),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Prakash),Maths (Leena),Sanskrit (Antima)
		Class 8,Hindi (Antima),Sanskrit (Antima),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Science (Hemlata),SST (Harshita)
		Class 9,Maths (Leena),English (Harshita),Hindi (Jainendra),CCS (Maya),Science (Toshit),Science (Toshit),Sanskrit (Antima),SST (Pradhyuman)
		Class 10,SST (Pradhyuman),CCS (Maya),Maths (Nathulal),Sanskrit (Antima),Hindi (Antima),English (Harshita),Science (Toshit),Maths (Nathulal)
		Class 11 Science,Physics (Phy),Physics (Phy),Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
		Class 11 Commerce,Self Study (Maya),Business (Nidhika),Economics (Prakash),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
		Class 11 Arts,English Literature (Harshita),Political Science (Pradhyuman),Economics (Prakash),Geography (Prakash),CCS (Maya),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Physics (Phy),Biology (Hemlata)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),CCS (Maya),Business (Pradhyuman),Hindi (Jainendra),English (Pradhyuman),Accountancy (Nathulal),Sports (Rakesh)
		Class 12 Arts,Geography (Prakash),Geography (Prakash),Political Science (Pradhyuman),Hindi (Jainendra),Hindi (Jainendra),English (Pradhyuman),English Literature (Harshita),Sports (Rakesh)

		Wednesday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,EVS (Bindu),Maths (Kusum),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Home Work (Anjana),Hindi (Bindu),Sports (Rakesh)
		Class 2,Maths (Anita),Hindi (Bindu),ELGA (Leena),ELGA (Leena),ELGA (Leena),Hindi (Bindu),EVS (Rashmita),Sports (Rakesh)
		Class 3,EVS (Rashmita),Home Work (Jainendra),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Maths (Anita),Maths (Anita),Maths (Anita)
		Class 4,Hindi (Kusum),EVS (Anita),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),Maths (Leena),Maths (Leena),Hindi (Kusum)
		Class 5,EVS (Nidhika),EVS (Nidhika),ELGA (Anita),ELGA (Anita),ELGA (Anita),Hindi (Kusum),Hindi (Kusum),Maths (Nidhika)
		Class 6,Science (Hemlata),SST (Rashmita),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),Science (Hemlata),CCS (Maya)
		Class 7,Hindi (Jainendra),Sanskrit (Antima),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Science (Hemlata),CCS (Maya),SST (Prakash)
		Class 8,Sanskrit (Antima),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),English Boards (Rashmita),SST (Harshita),Maths (Leena)
		Class 9,Maths (Leena),Maths (Leena),Hindi (Jainendra),Science (Toshit),Sports (Rakesh),Sanskrit (Antima),SST (Pradhyuman),English (Harshita)
		Class 10,SST (Pradhyuman),English (Harshita),Science (Toshit),Maths (Nathulal),Sanskrit (Antima),Science (Toshit),Hindi (Antima),Maths (Nathulal)
		Class 11 Science,Physics (Phy),Physics (Phy),English (Pradhyuman),Biology (Hemlata),Biology (Hemlata),Sports (Rakesh),Chemistry (Toshit),Chemistry (Toshit)
		Class 11 Commerce,CCS (Maya),Economics (Prakash),English (Pradhyuman),Self Study (Maya),Accountancy (Nathulal),Accountancy (Nathulal),Business (Nidhika),Sports (Rakesh)
		Class 11 Arts,English Literature (Harshita),Economics (Prakash),English (Pradhyuman),Geography (Prakash),Self Study (Toshit),Political Science (Pradhyuman),Sports (Rakesh),Sports (Rakesh)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),Hindi (Jainendra)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),CCS (Maya),Business (Pradhyuman),Hindi (Jainendra),English (Pradhyuman),Accountancy (Nathulal),Sports (Rakesh)
		Class 12 Arts,Geography (Prakash),Political Science (Pradhyuman),Economics (Prakash),Hindi (Jainendra),English (Pradhyuman),English Literature (Harshita),Hindi (Jainendra),Hindi (Jainendra)

		Thursday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,Hindi (Bindu),EVS (Bindu),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),EVS (Bindu),CCS (Maya),Hindi (Anjana)
		Class 2,Maths (Anita),Maths (Anita),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),EVS (Rashmita),Hindi (Bindu)
		Class 3,EVS (Rashmita),EVS (Rashmita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Hindi (Kusum),Home Work (Bindu),Maths (Anita)
		Class 4,Hindi (Kusum),CCS (Maya),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),EVS (Anita),EVS (Anita),Games (Rakesh)
		Class 5,EVS (Nidhika),Hindi (Kusum),ELGA (Anita),ELGA (Anita),ELGA (Anita),Home work (Anjana),Maths (Nidhika),Hindi (Kusum)
		Class 6,Science (Hemlata),Maths (Nidhika),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Hindi (Jainendra),Science (Hemlata),SST (Rashmita)
		Class 7,Hindi (Jainendra),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Prakash),Sanskrit (Antima),Maths (Leena)
		Class 8,Hindi (Antima),SST (Harshita),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Maths (Leena),Science (Hemlata)
		Class 9,Maths (Leena),Hindi (Jainendra),SST (Pradhyuman),SST (Pradhyuman),Sanskrit (Antima),Sanskrit (Antima),Science (Toshit),Science (Toshit)
		Class 10,SST (Pradhyuman),SST (Pradhyuman),Science (Toshit),Science (Toshit),Maths (Nathulal),Maths (Nathulal),English (Harshita),Sanskrit (Antima)
		Class 11 Science,Physics (Phy),Physics (Phy),Biology (Hemlata),Biology (Hemlata),Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),English (Pradhyuman)
		Class 11 Commerce,CCS (Maya),Economics (Prakash),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Business (Nidhika),Hindi (Jainendra),English (Pradhyuman)
		Class 11 Arts,English Literature (Harshita),Economics (Prakash),Geography (Prakash),Self Study (Antima),Political Science (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),Physics (Phy),Biology (Hemlata),Biology (Hemlata),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Economics (Prakash),Sports (Rakesh),Business (Pradhyuman),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Arts,Geography (Prakash),Self Study (Antima),Hindi (Jainendra),Economics (Prakash),Sports (Rakesh),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra)

		Friday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,Hindi (Bindu),Hindi (Bindu),Maths (Kusum),EVS (Bindu),Maths (Kusum),CCS (Maya),EVS (Bindu),EVS (Bindu)
		Class 2,Maths (Anita),Maths (Anita),Hindi (Bindu),EVS (Rashmita),Hindi (Bindu),Hindi (Bindu),CCS (Maya),EVS (Rashmita)
		Class 3,EVS (Rashmita),EVS (Rashmita),Maths (Anita),Maths (Anita),CCS (Maya),Hindi (Kusum),Hindi (Kusum),Home Work (Anjana)
		Class 4,Hindi (Kusum),Hindi (Kusum),Home Work (Rashmita),CCS (Maya),Maths (Leena),Maths (Leena),EVS (Anita),EVS (Anita)
		Class 5,EVS (Nidhika),EVS (Nidhika),Basic Hindi (Antima),Hindi (Kusum),Maths (Nidhika),Maths (Nidhika),Home Work (Anjana),Sports (Rakesh)
		Class 6,Science (Hemlata),Sanskrit (Jainendra),Maths (Nidhika),Maths (Nidhika),Sanskrit (Jainendra),SST (Rashmita),SST (Rashmita),Sports (Rakesh)
		Class 7,Hindi (Jainendra),Maths (Leena),Maths (Leena),Science (Hemlata),Science (Hemlata),Sanskrit (Antima),SST (Prakash),SST (Prakash)
		Class 8,Hindi (Antima),Science (Hemlata),Science (Hemlata),Maths (Leena),Sports (Rakesh),SST (Harshita),SST (Harshita),Sanskrit (Antima)
		Class 9,Maths (Leena),SST (Pradhyuman),Science (Toshit),Sanskrit (Antima),English (Harshita),Hindi (Jainendra),Sports (Rakesh),CCS (Maya)
		Class 10,SST (Pradhyuman),Sanskrit (Antima),Maths (Nathulal),English (Harshita),Hindi (Antima),Science (Toshit),Sports (Rakesh),English (Harshita)
		Class 11 Science,Physics (Phy),Physics (Phy),Hindi (Jainendra),Chemistry (Toshit),Chemistry (Toshit),English (Pradhyuman),Biology (Hemlata),Biology (Hemlata)
		Class 11 Commerce,Self Study (Maya),Economics (Prakash),Hindi (Jainendra),Accountancy (Nathulal),Accountancy (Nathulal),English (Pradhyuman),Business (Nidhika),Business (Nidhika)
		Class 11 Arts,English Literature (Harshita),Economics (Prakash),Hindi (Jainendra),Geography (Prakash),Political Science (Pradhyuman),English (Pradhyuman),Sports (Rakesh),Sports (Rakesh)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy),Physics (Phy),Sports (Rakesh),Biology (Hemlata),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),Sports (Rakesh),Accountancy (Nathulal),English (Pradhyuman),Hindi (Jainendra)
		Class 12 Arts,Geography (Prakash),English Literature (Harshita),Economics/Political Science (Prakash/Pradhyuman),English Literature (Harshita),Sports (Rakesh),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)

		Saturday
		Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
		Class 1,EVS (Bindu),EVS (Bindu),Hindi (Bindu),Hindi (Bindu),Sports (Rakesh),Maths (Kusum),Home Work (Anjana),Home Work (Bindu)
		Class 2,Maths (Anita),EVS (Rashmita),EVS (Rashmita),EVS (Rashmita),Sports (Rakesh),CCS (Maya),Hindi (Bindu),Home Work (Anita)
		Class 3,EVS (Rashmita),Maths (Anita),Hindi (Kusum),Hindi (Kusum),EVS (Rashmita),Home Work (Anjana),CCS (Maya),Home Work (Rashmita)
		Class 4,Hindi (Kusum),Hindi (Kusum),EVS (Anita),EVS (Anita),Home Work (Anjana),Maths (Leena),Maths (Leena),Maths (Leena)
		Class 5,Maths (Nidhika),Maths (Nidhika),CCS (Maya),EVS (Nidhika),EVS (Nidhika),Sports (Rakesh),Hindi (Kusum),Home Work (Anjana)
		Class 6,Science (Hemlata),Hindi (Jainendra),Maths (Nidhika),CCS (Maya),Sanskrit (Jainendra),Maths (Nidhika),SST (Rashmita),Hindi (Jainendra)
		Class 7,Hindi (Jainendra),Science (Hemlata),Science (Hemlata),Maths (Leena),SST (Prakash),English Basic (Rashmita),SST (Prakash),Sports (Rakesh)
		Class 8,Hindi (Antima),Sanskrit (Antima),Maths (Leena),Science (Hemlata),CCS (Maya),SST (Harshita),SST (Harshita),Sports (Rakesh)
		Class 9,Maths (Leena),Maths (Leena),Science (Toshit),Hindi (Jainendra),Maths (Leena),SST (Pradhyuman),Science (Toshit),English (Harshita)
		Class 10,SST (Pradhyuman),SST (Pradhyuman),Maths (Nathulal),Sanskrit (Antima),English (Harshita),Science (Toshit),SST (Pradhyuman),Hindi (Antima)
		Class 11 Science,Physics (Phy),Physics (Phy),Hindi (Jainendra),Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),Biology (Hemlata),Sports (Rakesh)
		Class 11 Commerce,Self Study (Maya),Economics (Prakash),Hindi (Jainendra),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Business (Nidhika),Business (Nidhika)
		Class 11 Arts,English Literature (Harshita),Economics (Prakash),Hindi (Jainendra),Geography (Prakash),Political Science (Pradhyuman),Hindi (Jainendra),Sports (Rakesh),Sports (Rakesh)
		Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy),Physics (Phy),Biology (Hemlata),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman)
		Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),Sports (Rakesh),Accountancy (Nathulal),Hindi (Jainendra),English (Pradhyuman)
		Class 12 Arts,Geography (Prakash),English Literature (Harshita),Economics/Political Science (Prakash/Pradhyuman),English Literature (Harshita),Sports (Rakesh),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)`;

		// --- ENHANCED GLOBAL STATE ---
		let state = {
			currentView: 'Dashboard',
			substitutions: {},
			allData: {},
			cache: new Map(),
			lastUpdate: null,
			performance: {
				renderTimes: [],
				avgRenderTime: 0
			}
		};

		const mainContent = document.getElementById('main-content');

		// --- UTILITY FUNCTIONS ---
		function showToast(message, duration = 3000, type = 'info') {
			const existingToast = document.querySelector('.toast');
			if (existingToast) existingToast.remove();

			const toast = document.createElement('div');
			toast.className = `toast ${type}`;
			toast.innerHTML = `<span>${message}</span>`;
			document.body.appendChild(toast);

			setTimeout(() => {
				toast.style.opacity = '0';
				setTimeout(() => toast.remove(), 300);
			}, duration);
		}

		function scrollToTop() {
			window.scrollTo({ top: 0, behavior: 'smooth' });
		}

		function debounce(func, wait) {
			let timeout;
			return function executedFunction(...args) {
				const later = () => {
					clearTimeout(timeout);
					func(...args);
				};
				clearTimeout(timeout);
				timeout = setTimeout(later, wait);
			};
		}

		function getCurrentDay() {
			const today = new Date();
			const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
			
			// Map Sunday to Monday for school context
			if (dayName === 'Sunday') return 'Monday';
			
			// Ensure the day exists in our timetable
			if (state.allData && state.allData.days && state.allData.days.includes(dayName)) {
				return dayName;
			}
			
			// Fallback to Monday
			return 'Monday';
		}

		function getCurrentPeriod() {
			const now = new Date();
			const hour = now.getHours();
			const minute = now.getMinutes();
			const timeInMinutes = hour * 60 + minute;

			// School time periods in minutes from midnight
			const periods = [
				{ start: 8 * 60 + 30, end: 9 * 60 + 10 },   // 8:30-9:10
				{ start: 9 * 60 + 10, end: 9 * 60 + 50 },   // 9:10-9:50
				{ start: 9 * 60 + 50, end: 10 * 60 + 30 },  // 9:50-10:30
				{ start: 10 * 60 + 30, end: 11 * 60 + 10 }, // 10:30-11:10
				{ start: 11 * 60 + 30, end: 12 * 60 + 10 }, // 11:30-12:10
				{ start: 12 * 60 + 10, end: 12 * 60 + 50 }, // 12:10-12:50
				{ start: 12 * 60 + 50, end: 13 * 60 + 30 }, // 12:50-13:30
				{ start: 13 * 60 + 30, end: 14 * 60 + 10 }  // 13:30-14:10
			];

			for (let i = 0; i < periods.length; i++) {
				if (timeInMinutes >= periods[i].start && timeInMinutes <= periods[i].end) {
					return i + 1;
				}
			}

			// If outside school hours, return appropriate period
			if (timeInMinutes < periods[0].start) return 1;
			return Math.min(8, periods.length);
		}

		// --- ENHANCED DATA PARSING ---
		const parseTimetableData = () => {
			const timetable = {};
			const teacherDetails = {};
			let headers = [];

			try {
				// Enhanced data cleaning
				const correctedData = rawData
					.replace(/\(Nindika\)/g, '(Nidhika)')
					.replace(/\s+Sir/g, '')
					.replace(/english/g, 'English');

				// Split by days - properly handle all days including Saturday
				const lines = correctedData.trim().split('\n').map(line => line.trim()).filter(line => line);
				const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
				
				let currentDay = null;
				let currentDayData = [];
				
				for (let i = 0; i < lines.length; i++) {
					const line = lines[i];
					
					// Check if this line is a day name
					if (dayNames.includes(line)) {
						// Process previous day data if exists
						if (currentDay && currentDayData.length > 0) {
							processDay(currentDay, currentDayData);
						}
						
						// Start new day
						currentDay = line;
						currentDayData = [];
					} else if (currentDay) {
						currentDayData.push(line);
					}
				}
				
				// Process the last day
				if (currentDay && currentDayData.length > 0) {
					processDay(currentDay, currentDayData);
				}

				function processDay(day, dayData) {
					timetable[day] = {};
					
					// First line should be headers (periods)
					if (dayData.length > 0 && dayData[0].includes('Period 1')) {
						if (headers.length === 0) { // Only set headers once
							headers.splice(0, headers.length, ...dayData[0].split(',').slice(1).map(h => {
								const parts = h.split('<br>');
								return { 
									name: parts[0]?.trim() || `Period ${h}`, 
									time: parts[1]?.trim() || '' 
								};
							}));
						}
						
						// Process class data (skip header line)
						for (let j = 1; j < dayData.length; j++) {
							const line = dayData[j];
							if (!line.trim()) continue;
							
							const columns = line.split(',').map(col => col.trim());
							const className = columns[0];
							
							if (!className) continue;
							
							timetable[day][className] = [];

							columns.slice(1).forEach((cell, periodIndex) => {
								const match = cell.match(/^(.+?)\s*\(([^)]+)\)$/);
								let entry = { 
									subject: cell, 
									teacher: null, 
									period: periodIndex, 
									className, 
									day 
								};

								if (match) {
									entry.subject = match[1].trim();
									entry.teacher = match[2].trim();
								}

								timetable[day][className].push(entry);

								// Enhanced teacher tracking
								if (entry.teacher) {
									const teachersInCell = entry.teacher.split('/').map(t => t.trim());
									const subjectsInCell = entry.subject.split('/').map(s => s.trim());

									teachersInCell.forEach((teacherName, k) => {
										if (!teacherDetails[teacherName]) {
											teacherDetails[teacherName] = { 
												schedule: {}, 
												periodCount: 0, 
												subjects: new Set(),
												workload: {}
											};
										}

										if (!teacherDetails[teacherName].schedule[day]) {
											teacherDetails[teacherName].schedule[day] = Array(headers.length).fill(null);
										}

										const subjectForTeacher = subjectsInCell[k] || subjectsInCell[0];
										teacherDetails[teacherName].schedule[day][periodIndex] = { 
											subject: subjectForTeacher, 
											className 
										};
										teacherDetails[teacherName].periodCount++;
										teacherDetails[teacherName].subjects.add(subjectForTeacher);

										// Calculate daily workload
										if (!teacherDetails[teacherName].workload[day]) {
											teacherDetails[teacherName].workload[day] = 0;
										}
										teacherDetails[teacherName].workload[day]++;
									});
								}
							});
						}
					}
				}

				// Enhanced class sorting
				const classNames = Object.keys(timetable.Monday || {}).sort((a, b) => {
					const extractNumber = (str) => {
						const match = str.match(/(\d+)/);
						return match ? parseInt(match[1]) : 999;
					};
					
					const numA = extractNumber(a);
					const numB = extractNumber(b);
					
					if (numA !== numB) return numA - numB;
					return a.localeCompare(b);
				});

				const result = { 
					timetable, 
					teacherDetails, 
					periodHeaders: headers, 
					classNames, 
					teacherNames: Object.keys(teacherDetails).sort(),
					days: Object.keys(timetable)
				};

				console.log('Parsed timetable days:', Object.keys(timetable));
				console.log('Sample Saturday data:', timetable.Saturday ? Object.keys(timetable.Saturday).length + ' classes' : 'No Saturday data');
				
				state.cache.set('parsedData', result);
				state.lastUpdate = Date.now();
				
				return result;

			} catch (error) {
				console.error('Error parsing timetable data:', error);
				// Return minimal data structure to prevent crashes
				return {
					timetable: { Monday: {} },
					teacherDetails: {},
					periodHeaders: [],
					classNames: [],
					teacherNames: [],
					days: ['Monday']
				};
			}
		};

		// --- FREE TEACHER FINDER ---
		function findFreeTeachers(day, periodIndex, absentTeachers, currentDaySubs) {
			try {
				// Validate inputs
				if (!state.allData || !state.allData.teacherNames) {
					console.error('Teacher data not available');
					return [];
				}

				if (!state.allData.days.includes(day)) {
					console.error('Day not found in timetable:', day);
					return [];
				}

				if (periodIndex < 0 || periodIndex >= (state.allData.periodHeaders?.length || 8)) {
					console.error('Invalid period index:', periodIndex);
					return [];
				}

				const cacheKey = `free-${day}-${periodIndex}-${absentTeachers.join(',')}-${JSON.stringify(currentDaySubs)}`;
				if (state.cache.has(cacheKey)) {
					return state.cache.get(cacheKey);
				}

				const free = [];
				
				for (const teacher of state.allData.teacherNames) {
					// Skip if absent
					if (absentTeachers.includes(teacher)) continue;
					
					// Skip special cases
					if (teacher === 'Gyan' || teacher === 'Phy') continue;
					
					// Anjana only available after period 4
					if (teacher === 'Anjana' && periodIndex < 4) continue;

					// Check if teacher has a regular class this period
					const teacherSchedule = state.allData.teacherDetails[teacher]?.schedule[day];
					if (teacherSchedule && teacherSchedule[periodIndex]) {
						continue;
					}

					// Check if already assigned as substitute
					let isBusyAsSub = false;
					for (const cName in currentDaySubs) {
						if (currentDaySubs[cName][periodIndex] === teacher) {
							isBusyAsSub = true;
							break;
						}
					}
					if (isBusyAsSub) continue;

					free.push(teacher);
				}

				// Sort by current workload (ascending)
				free.sort((a, b) => {
					const workloadA = state.allData.teacherDetails[a]?.workload[day] || 0;
					const workloadB = state.allData.teacherDetails[b]?.workload[day] || 0;
					return workloadA - workloadB;
				});

				console.log(`Free teachers for ${day} period ${periodIndex + 1}:`, free);

				state.cache.set(cacheKey, free);
				return free;

			} catch (error) {
				console.error('Error finding free teachers:', error);
				return [];
			}
		}

		// --- ENHANCED FREE TEACHER FINDER RENDER ---
		function renderFreeTeacherFinder(day = null, period = null) {
			const container = document.getElementById('free-teacher-finder-container');
			if (!container) return;

			try {
				// Ensure we have data
				if (!state.allData || !state.allData.days || state.allData.days.length === 0) {
					container.innerHTML = `
						<div style="color: var(--red-500); padding: 2rem; text-align: center; border: 2px dashed var(--red-200); border-radius: var(--radius);">
							<i data-lucide="alert-circle" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"></i><br>
							Data not loaded yet. Please wait...
						</div>
					`;
					lucide.createIcons();
					return;
				}

				// Smart defaults based on current time
				const currentDay = day || getCurrentDay();
				const currentPeriod = period || getCurrentPeriod();
				const periodIndex = currentPeriod - 1;

				// Validate that the selected day exists
				if (!state.allData.days.includes(currentDay)) {
					container.innerHTML = `
						<div style="color: var(--red-500); padding: 2rem; text-align: center; border: 2px dashed var(--red-200); border-radius: var(--radius);">
							<i data-lucide="alert-circle" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"></i><br>
							Day "${currentDay}" not found in timetable data.
						</div>
					`;
					lucide.createIcons();
					return;
				}

				const freeTeachers = findFreeTeachers(currentDay, periodIndex, [], {});

				const dayOptions = state.allData.days.map(d =>
					`<option value="${d}" ${d === currentDay ? 'selected' : ''}>${d}</option>`
				).join('');

				const periodOptions = state.allData.periodHeaders.map((p, i) =>
					`<option value="${i+1}" ${i+1 == currentPeriod ? 'selected' : ''}>${p.name} ${p.time ? `(${p.time})` : ''}</option>`
				).join('');

				const freeTeachersList = freeTeachers.length > 0
					? freeTeachers.map(t => {
						const workload = state.allData.teacherDetails[t]?.workload[currentDay] || 0;
						return `
							<div style="background: var(--primary-50); color: var(--primary-800); padding: 0.75rem;
										border-radius: var(--radius); font-size: 0.875rem; font-weight: 500;
										display: flex; justify-content: space-between; align-items: center;
										border-left: 3px solid var(--primary-500);">
								<span>${t}</span>
								<small style="opacity: 0.7; background: var(--primary-100); padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem;">
									${workload} periods today
								</small>
							</div>
						`;
					}).join('')
					: `<div style="color: var(--gray-500); padding: 2rem; text-align: center; border: 2px dashed var(--gray-200); border-radius: var(--radius);">
					   <i data-lucide="user-x" style="width: 24px; height: 24px; margin-bottom: 0.5rem; color: var(--gray-400);"></i><br>
					   No teachers are free for this slot.
				   </div>`;

				const currentTime = new Date().toLocaleTimeString('en-US', { 
					hour: '2-digit', 
					minute: '2-digit',
					hour12: true
				});

				const html = `
					<div style="background: linear-gradient(135deg, var(--primary-50) 0%, var(--blue-50) 100%); 
								padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 1rem;
								border: 1px solid var(--primary-200);">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
							<div>
								<strong style="color: var(--primary-700);">Current Time: ${currentTime}</strong>
							</div>
							<div style="display: flex; align-items: center; gap: 0.5rem;">
								<div style="width: 8px; height: 8px; background: var(--green-500); border-radius: 50%; animation: pulse 2s infinite;"></div>
								<small style="color: var(--primary-600); font-weight: 500;">Live Updates</small>
							</div>
						</div>
						<small style="color: var(--primary-600);">
							Showing free teachers for ${currentDay}, Period ${currentPeriod}
						</small>
					</div>
					
					<div class="grid grid-cols-1 grid-cols-md-2 gap-4 mb-4">
						<div>
							<label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--gray-700);">
								<i data-lucide="calendar" style="width: 16px; height: 16px; display: inline; margin-right: 0.25rem;"></i>
								Day
							</label>
							<select id="finder-day-select" style="border: 2px solid var(--primary-200);">${dayOptions}</select>
						</div>
						<div>
							<label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--gray-700);">
								<i data-lucide="clock" style="width: 16px; height: 16px; display: inline; margin-right: 0.25rem;"></i>
								Period
							</label>
							<select id="finder-period-select" style="border: 2px solid var(--primary-200);">${periodOptions}</select>
						</div>
					</div>
					
					<div style="max-height: 20rem; overflow-y: auto; padding: 0.5rem;
								background: var(--gray-50); border-radius: var(--radius-lg);
								border: 1px solid var(--gray-200);">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
							<h4 style="color: var(--gray-700); margin: 0;">
								<i data-lucide="users-check" style="width: 18px; height: 18px; display: inline; margin-right: 0.5rem;"></i>
								Available Teachers
							</h4>
							<span style="background: var(--primary-600); color: white; padding: 0.25rem 0.5rem; 
									 border-radius: var(--radius); font-size: 0.75rem; font-weight: 600;">
							${freeTeachers.length} free
						</span>
						</div>
						<div style="display: flex; flex-direction: column; gap: 0.5rem;">
							${freeTeachersList}
						</div>
					</div>
				`;

				container.innerHTML = html;

				// Enhanced event listeners
				document.getElementById('finder-day-select').addEventListener('change', (e) => {
					const newDay = e.target.value;
					const newPeriod = document.getElementById('finder-period-select').value;
					renderFreeTeacherFinder(newDay, newPeriod);
				});

				document.getElementById('finder-period-select').addEventListener('change', (e) => {
					const newDay = document.getElementById('finder-day-select').value;
					const newPeriod = e.target.value;
					renderFreeTeacherFinder(newDay, newPeriod);
				});

				lucide.createIcons();

			} catch (error) {
				console.error('Error rendering free teacher finder:', error);
				container.innerHTML = `
					<div style="color: var(--red-500); padding: 2rem; text-align: center; border: 2px dashed var(--red-200); border-radius: var(--radius);">
						<i data-lucide="alert-circle" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"></i><br>
						Error loading free teacher finder. Please refresh the page.
					</div>
				`;
				lucide.createIcons();
			}
		}

		const debouncedRenderFreeTeacher = debounce(renderFreeTeacherFinder, 300);

		// --- DASHBOARD RENDER ---
		function renderDashboard() {
			try {
				const today = getCurrentDay();
				const { teacherDetails, teacherNames, timetable, classNames } = state.allData;

				const substitutionCount = Object.values(state.substitutions[today]?.plan || {}).reduce((acc, classSubs) =>
					acc + Object.keys(classSubs).length, 0);
				
				const totalClassesToday = timetable[today] ?
					Object.values(timetable[today]).flat().filter(p => p.teacher).length : 0;

				const totalTeachers = teacherNames.length;
				const activeTeachersToday = new Set();
				
				if (timetable[today]) {
					Object.values(timetable[today]).flat().forEach(period => {
						if (period.teacher) {
							period.teacher.split('/').forEach(t => activeTeachersToday.add(t.trim()));
						}
					});
				}

				const html = `
					<div class="stat-grid">
						<div class="stat-card">
							<div class="stat-card-icon" style="background: var(--primary-500);">
								<i data-lucide="calendar"></i>
							</div>
							<div>
								<div class="stat-card-label">Today's Date</div>
								<div class="stat-card-value">${new Date().toLocaleDateString('en-GB')}</div>
								<small style="color: var(--gray-500);">${today}</small>
							</div>
						</div>
						<div class="stat-card">
							<div class="stat-card-icon" style="background: var(--green-500);">
								<i data-lucide="book-open"></i>
							</div>
							<div>
								<div class="stat-card-label">Classes Today</div>
								<div class="stat-card-value">${totalClassesToday}</div>
								<small style="color: var(--gray-500);">${classNames.length} total classes</small>
							</div>
						</div>
						<div class="stat-card">
							<div class="stat-card-icon" style="background: var(--yellow-500);">
								<i data-lucide="users"></i>
							</div>
							<div>
								<div class="stat-card-label">Active Teachers</div>
								<div class="stat-card-value">${activeTeachersToday.size}</div>
								<small style="color: var(--gray-500);">of ${totalTeachers} total</small>
							</div>
						</div>
						<div class="stat-card">
							<div class="stat-card-icon" style="background: var(--red-500);">
								<i data-lucide="user-check"></i>
							</div>
							<div>
								<div class="stat-card-label">Substitutions</div>
								<div class="stat-card-value">${substitutionCount}</div>
								<small style="color: var(--gray-500);">active today</small>
							</div>
						</div>
					</div>

					<div class="card">
						<h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
							<i data-lucide="search" style="width: 20px; height: 20px;"></i>
							Live Free Teacher Finder
						</h2>
						<div id="free-teacher-finder-container"></div>
					</div>

					<div class="card">
						<h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
							<i data-lucide="zap" style="width: 20px; height: 20px;"></i>
							Quick Actions
						</h2>
						<div class="grid grid-cols-1 grid-cols-md-2 gap-4">
							<button class="button button-primary" onclick="switchView('Day')">
								<i data-lucide="calendar"></i> View Today's Schedule
							</button>
							<button class="button button-primary" onclick="switchView('Substitution')">
								<i data-lucide="user-cog"></i> Manage Substitutions
							</button>
							<button class="button button-secondary" onclick="switchView('Class')">
								<i data-lucide="school"></i> Browse Classes
							</button>
							<button class="button button-secondary" onclick="switchView('Teacher')">
								<i data-lucide="users"></i> Teacher Schedules
							</button>
						</div>
					</div>

					<div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
						<button onclick="handlePrint()" class="button button-secondary" style="max-width:200px;">
							<i data-lucide="printer"></i> Print Full Timetable
						</button>
					</div>
				`;

				mainContent.innerHTML = html;
				renderFreeTeacherFinder();
				lucide.createIcons();

				// Auto-refresh free teachers every 30 seconds
				if (!window.dashboardInterval) {
					window.dashboardInterval = setInterval(() => {
						if (state.currentView === 'Dashboard') {
							renderFreeTeacherFinder();
						}
					}, 30000);
				}

			} catch (error) {
				console.error('Error rendering dashboard:', error);
				mainContent.innerHTML = `
					<div class="card">
						<div style="color: var(--red-500); padding: 2rem; text-align: center;">
							<i data-lucide="alert-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><br>
							<h3>Error Loading Dashboard</h3>
							<p>Please refresh the page to try again.</p>
						</div>
					</div>
				`;
				lucide.createIcons();
			}
		}

		// --- FIXED DAY VIEW RENDER ---
		function renderDayView(day = null) {
			try {
				const selectedDay = day || getCurrentDay();
				const { timetable, classNames, periodHeaders } = state.allData;

				// Validate that the selected day exists in timetable
				if (!timetable[selectedDay]) {
					console.error(`Day ${selectedDay} not found in timetable`);
					showToast(`❌ No timetable data found for ${selectedDay}`);
					return;
				}

				const daySubs = state.substitutions[selectedDay]?.plan || {};

				const dayButtons = state.allData.days.map(d =>
					`<button class="nav-button ${selectedDay === d ? 'active' : ''}" onclick="renderDayView('${d}')">
						${d === getCurrentDay() ? '🔴 ' : ''}${d}
					</button>`
				).join('');

				document.getElementById('print-header-subtitle').textContent = `Daily Schedule for ${selectedDay}`;

				const tableHeader = '<th>Class</th>' + periodHeaders.map(h =>
					`<th>${h.name}<br/><span style="font-weight:400; font-size: 0.75rem;">${h.time}</span></th>`
				).join('');

				const tableBody = classNames.map(cName => {
					// Check if class exists for this day
					if (!timetable[selectedDay][cName]) {
						console.warn(`Class ${cName} not found for ${selectedDay}`);
						return '';
					}

					return `
						<tr>
							<td class="font-bold" data-label="Class">${cName}</td>
							${timetable[selectedDay][cName].map((period, i) => {
								const substitute = daySubs[cName]?.[i];
								const label = `${periodHeaders[i]?.name || `Period ${i+1}`} (${periodHeaders[i]?.time || ''})`;
								return `
									<td data-label="${label}">
										<div class="subject">${period.subject || 'No Subject'}</div>
										${period.teacher ? `<div class="teacher ${substitute ? 'line-through' : ''}">${period.teacher}</div>` : ''}
										${substitute ? `<div class="teacher substitute">Sub: ${substitute}</div>` : ''}
									</td>
								`;
							}).join('')}
						</tr>
					`;
				}).filter(row => row).join('');

				const html = `
					<div class="card">
						<div class="flex items-center justify-between flex-wrap gap-4">
							<h2 style="font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
								<i data-lucide="calendar-days"></i>
								${selectedDay} Schedule
								${selectedDay === getCurrentDay() ? '<span style="color: var(--red-500); font-size: 0.75rem;">● LIVE</span>' : ''}
							</h2>
							<div class="flex gap-2">
								<button onclick="handlePrint()" class="button button-secondary" style="width: auto;">
									<i data-lucide="printer"></i>
								</button>
								<button onclick="handleShareScreenshot()" class="button button-whatsapp" style="width: auto;">
									<i data-lucide="share-2"></i>
								</button>
							</div>
						</div>
						<div class="flex flex-wrap gap-2" style="border-bottom: 1px solid var(--gray-200);
						 padding-bottom: 0.75rem; margin: 1rem 0;">
							${dayButtons}
						</div>
						<div class="table-container">
							<table class="responsive">
								<thead><tr>${tableHeader}</tr></thead>
								<tbody>${tableBody}</tbody>
							</table>
						</div>
					</div>
				`;

				mainContent.innerHTML = html;
				lucide.createIcons();

			} catch (error) {
				console.error('Error rendering day view:', error);
				mainContent.innerHTML = `
					<div class="card">
						<div style="color: var(--red-500); padding: 2rem; text-align: center;">
							<i data-lucide="alert-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><br>
							<h3>Error Loading Day View</h3>
							<p>Failed to load schedule for ${day || getCurrentDay()}. Please try again.</p>
							<button onclick="switchView('Dashboard')" class="button button-primary" style="margin-top: 1rem; max-width: 200px;">
								Return to Dashboard
							</button>
						</div>
					</div>
				`;
				lucide.createIcons();
			}
		}

		// --- COMPLETE MISSING RENDER FUNCTIONS ---
		function renderClassView(selectedClass = '') {
			try {
				const { timetable, classNames, periodHeaders } = state.allData;
				document.getElementById('print-header-subtitle').textContent =
					selectedClass ? `Weekly Schedule for ${selectedClass}` : 'Class Timetables';

				const classOptions = '<option value="">-- Select a Class --</option>' +
					classNames.map(c =>
						`<option value="${c}" ${c === selectedClass ? 'selected' : ''}>${c}</option>`
					).join('');

				let tableHtml = '';
				if (selectedClass && timetable.Monday && timetable.Monday[selectedClass]) {
					const tableHeader = '<th>Day</th>' + periodHeaders.map(h =>
						`<th>${h.name}<br/><span style="font-weight:400; font-size: 0.75rem;">${h.time}</span></th>`
					).join('');

					const tableBody = Object.keys(timetable).map(day => {
						const daySchedule = timetable[day][selectedClass] || [];
						const daySubs = state.substitutions[day]?.plan || {};

						return `
							<tr>
								<td class="font-bold" data-label="Day">${day}</td>
								${periodHeaders.map((_, i) => {
									const originalPeriod = daySchedule[i];
									const isSubstitutedOut = originalPeriod &&
										daySubs[originalPeriod.className]?.[i];

									let subPeriodInfo = null;
									for (const cName in daySubs) {
										if (daySubs[cName][i] === selectedTeacher) {
											subPeriodInfo = timetable[day][cName][i];
											break;
										}
									}

									const label = periodHeaders[i]?.name || `Period ${i+1}`;
									return `
										<td data-label="${label}">
											${originalPeriod ? `
												<div class="${isSubstitutedOut ? 'line-through' : ''}">
													<div class="subject">${originalPeriod.subject}</div>
													<div class="class-name">${originalPeriod.className}</div>
												</div>
											` : ''}
											${subPeriodInfo ? `
												<div style="margin-top: 0.25rem;">
													<div class="subject substitute">${subPeriodInfo.subject}</div>
													<div class="class-name">(Sub for ${subPeriodInfo.teacher})</div>
													<div class="class-name">${subPeriodInfo.className}</div>
												</div>
											` : ''}
										</td>
									`;
								}).join('')}
							</tr>
						`;
					}).join('');

					tableHtml = `
						<div class="table-container">
							<table class="responsive">
								<thead><tr>${tableHeader}</tr></thead>
								<tbody>${tableBody}</tbody>
							</table>
						</div>
						<div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
							<button onclick="handlePrint()" class="button button-secondary" style="max-width: 200px;">
								<i data-lucide="printer"></i> Print
							</button>
							<button onclick="handleShareScreenshot()" class="button button-whatsapp" style="max-width: 200px;">
								<i data-lucide="share-2"></i> Share
							</button>
						</div>
					`;
				}

				const html = `
					<div class="card">
						<h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">
							🏫 View by Class
						</h2>
						<select onchange="renderClassView(this.value)">${classOptions}</select>
						${tableHtml}
					</div>
				`;

				mainContent.innerHTML = html;
				lucide.createIcons();

			} catch (error) {
				console.error('Error rendering class view:', error);
				showToast('❌ Error loading class view');
			}
		}

		function renderTeacherView(selectedTeacher = '') {
			try {
				const { teacherDetails, teacherNames, periodHeaders, timetable } = state.allData;
				document.getElementById('print-header-subtitle').textContent =
					selectedTeacher ? `Weekly Schedule for ${selectedTeacher}` : 'Teacher Timetables';

				const teacherOptions = '<option value="">-- Select a Teacher --</option>' +
					teacherNames.map(t =>
						`<option value="${t}" ${t === selectedTeacher ? 'selected' : ''}>${t}</option>`
					).join('');

				let detailsHtml = '';
				if (selectedTeacher && teacherDetails[selectedTeacher]) {
					const tableHeader = '<th>Day</th>' + periodHeaders.map(h => `<th>${h.name}</th>`).join('');
					const tableBody = Object.keys(timetable).map(day => {
						const daySchedule = teacherDetails[selectedTeacher].schedule[day] || [];
						const daySubs = state.substitutions[day]?.plan || {};

						return `
							<tr>
								<td class="font-bold" data-label="Day">${day}</td>
								${periodHeaders.map((_, i) => {
									const originalPeriod = daySchedule[i];
									const isSubstitutedOut = originalPeriod &&
										daySubs[originalPeriod.className]?.[i];

									let subPeriodInfo = null;
									for (const cName in daySubs) {
										if (daySubs[cName][i] === selectedTeacher) {
											subPeriodInfo = timetable[day][cName][i];
											break;
										}
									}

									const label = periodHeaders[i]?.name || `Period ${i+1}`;
									return `
										<td data-label="${label}">
											${originalPeriod ? `
												<div class="${isSubstitutedOut ? 'line-through' : ''}">
													<div class="subject">${originalPeriod.subject}</div>
													<div class="class-name">${originalPeriod.className}</div>
												</div>
											` : ''}
											${subPeriodInfo ? `
												<div style="margin-top: 0.25rem;">
													<div class="subject substitute">${subPeriodInfo.subject}</div>
													<div class="class-name">(Sub for ${subPeriodInfo.teacher})</div>
													<div class="class-name">${subPeriodInfo.className}</div>
												</div>
											` : ''}
										</td>
									`;
								}).join('')}
							</tr>
						`;
					}).join('');

					detailsHtml = `
						<div class="mt-4">
							<div style="background: var(--primary-50); color: var(--primary-800);
										font-weight: 600; text-align: center; border-radius: var(--radius);
										padding: 0.75rem; margin-bottom: 1.5rem;">
								Total Weekly Periods: ${teacherDetails[selectedTeacher].periodCount}
							</div>
						</div>
						<div class="table-container">
							<table class="responsive">
								<thead><tr>${tableHeader}</tr></thead>
								<tbody>${tableBody}</tbody>
							</table>
						</div>
						<div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
							<button onclick="handlePrint()" class="button button-secondary" style="max-width: 200px;">
								<i data-lucide="printer"></i> Print
							</button>
							<button onclick="handleShareScreenshot()" class="button button-whatsapp" style="max-width: 200px;">
								<i data-lucide="share-2"></i> Share
							</button>
						</div>
					`;
				}

				const html = `
					<div class="card">
						<h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">
							👨‍🏫 View by Teacher
						</h2>
						<select onchange="renderTeacherView(this.value)">${teacherOptions}</select>
						<div id="teacher-details-container">${detailsHtml}</div>
					</div>
				`;

				mainContent.innerHTML = html;
				lucide.createIcons();

			} catch (error) {
				console.error('Error rendering teacher view:', error);
				showToast('❌ Error loading teacher view');
			}
		}

		// --- ENHANCED PRINT FUNCTIONS ---
		function renderFullTimetableForPrint() {
			const { timetable, classNames, periodHeaders, days } = state.allData;
			let html = '';
			days.forEach(day => {
				html += `<h3 style="margin:1rem 0 0.5rem 0;font-size:1.1em;">${day}</h3>`;
				html += `<div class="table-container"><table class="responsive"><thead><tr><th>Class</th>`;
				html += periodHeaders.map(h => `<th>${h.name}<br><span style="font-weight:400;font-size:0.75em;">${h.time}</span></th>`).join('');
				html += `</tr></thead><tbody>`;
				classNames.forEach(cName => {
					if (!timetable[day][cName]) return;
					html += `<tr><td class="font-bold" data-label="Class">${cName}</td>`;
					html += timetable[day][cName].map((period, i) => {
						const label = `${periodHeaders[i]?.name || `Period ${i+1}`} (${periodHeaders[i]?.time || ''})`;
						return `<td data-label="${label}">
							<div class="subject">${period.subject || 'No Subject'}</div>
							${period.teacher ? `<div class="teacher">${period.teacher}</div>` : ''}
						</td>`;
					}).join('');
					html += `</tr>`;
				});
				html += `</tbody></table></div>`;
			});
			return html;
		}

		function preparePrintContent() {
			try {
				const printContent = renderFullTimetableForPrint();
				document.getElementById('print-header-subtitle').textContent = "Full School Timetable";
				document.getElementById('print-content').innerHTML = printContent;
				return true;
			} catch (error) {
				console.error('Error preparing print content:', error);
				return false;
			}
		}

		function handlePrint() {
			try {
				if (preparePrintContent()) {
					const captureElement = document.getElementById('print-capture-area');
					const prev = captureElement.style.display;
					captureElement.style.display = 'block';
					setTimeout(() => {
						window.print();
						captureElement.style.display = prev || 'none';
					}, 100);
				} else {
					showToast("⚠️ No printable content available.");
				}
			} catch (error) {
				console.error('Print error:', error);
				showToast("❌ Print failed. Please try again.");
			}
		}

		// --- FIX SUBSTITUTION VIEW ---
		function renderSubstitutionView(day = null, absentTeachers = []) {
			const { teacherNames, periodHeaders, teacherDetails, timetable, days } = state.allData;
			const selectedDay = day || days[0];
			document.getElementById('print-header-subtitle').textContent = `Substitution Plan for ${selectedDay}`;

			const dayOptions = days.map(d =>
				`<option value="${d}" ${d === selectedDay ? 'selected' : ''}>${d}</option>`
			).join('');

			const teacherOptionsHtml = teacherNames.map(t => `
				<label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;
							  border-radius: var(--radius); cursor: pointer; transition: background 0.2s;">
					<input type="checkbox" value="${t}" ${absentTeachers.includes(t) ? 'checked' : ''}
						   onchange="handleAbsentTeacherChange(this)">
					<span>${t}</span>
				</label>
			`).join('');

			const daySubsData = state.substitutions[selectedDay]?.plan || {};
			const vacantSlots = [];
			absentTeachers.forEach(absentTeacher => {
				const schedule = teacherDetails[absentTeacher]?.schedule[selectedDay];
				if (schedule) {
					schedule.forEach((period, periodIndex) => {
						if (period) {
							vacantSlots.push({ ...period, periodIndex, originalTeacher: absentTeacher });
						}
					});
				}
			});

			const plan = vacantSlots.map(slot => {
				const substitute = daySubsData[slot.className]?.[slot.periodIndex];
				return { ...slot, substitute };
			}).sort((a, b) => a.periodIndex - b.periodIndex);

			let planTableHTML = '';
			if (plan.length > 0) {
				const tableRows = plan.map(slot => `
					<tr>
						<td>${periodHeaders[slot.periodIndex].name}</td>
						<td>${slot.className}</td>
						<td>${slot.subject}</td>
						<td style="color: var(--red-600);">${slot.originalTeacher}</td>
						<td><span class="substitute">${slot.substitute || '--'}</span></td>
					</tr>
				`).join('');

				planTableHTML = `
					<div style="margin-top: 2rem;">
						<div id="substitution-plan-content">
							<h3 style="text-align: center; margin-bottom: 1rem; font-size: 1.25rem;">
								📋 Substitution Plan: ${selectedDay}
							</h3>
							<div class="table-container">
								<table>
									<thead>
										<tr>
											<th>Period</th>
											<th>Class</th>
											<th>Subject</th>
											<th>Original Teacher</th>
											<th>Substitute</th>
										</tr>
									</thead>
									<tbody>${tableRows}</tbody>
								</table>
							</div>
							<div class="grid grid-cols-1 grid-cols-md-2 gap-4" style="margin-top: 1.5rem;">
								<button onclick="handleShareSubstitutionWhatsApp('${selectedDay}')" class="button button-whatsapp">
									<i data-lucide="share-2"></i> Share via WhatsApp
								</button>
								<button onclick="handleDownloadSubstitutionImage('${selectedDay}')" class="button button-primary">
									<i data-lucide="download"></i> Download as Image
								</button>
							</div>
						</div>
					</div>
				`;
			}

			const html = `
				<div class="card">
					<div class="grid grid-cols-1 grid-cols-md-2 gap-6">
						<div>
							<label class="block font-bold mb-2">1. Select Day</label>
							<select id="sub-day-select" onchange="handleSubDayChange(this.value)">
								${dayOptions}
							</select>
						</div>
						<div>
							<label class="block font-bold mb-2">2. Select Absent Teachers</label>
							<div style="border: 1px solid var(--gray-300); border-radius: var(--radius);
										padding: 0.5rem; max-height: 15rem; overflow-y: auto;">
								${teacherOptionsHtml}
							</div>
						</div>
					</div>
					<div class="grid grid-cols-1 grid-cols-md-2 gap-4"
						 style="border-top: 1px solid var(--gray-200); padding-top: 1.5rem; margin-top: 1.5rem;">
						<button id="generate-plan-btn" class="button button-primary">
							<i data-lucide="wand-2"></i> Generate Smart Plan
						</button>
						<button id="reset-plan-btn" class="button button-danger">
							<i data-lucide="rotate-ccw"></i> Reset ${selectedDay} Plan
						</button>
					</div>
					<div id="plan-container">${planTableHTML}</div>
					<div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
						<button onclick="handlePrint()" class="button button-secondary" style="max-width: 200px;">
							<i data-lucide="printer"></i> Print Full Timetable
						</button>
					</div>
				</div>
			`;

			mainContent.innerHTML = html;
			attachSubstitutionEventListeners(selectedDay, absentTeachers);
			lucide.createIcons();
		}

		// --- EVENT HANDLERS & LOGIC ---
		function attachSubstitutionEventListeners(day, absentTeachers) {
			document.getElementById('generate-plan-btn').addEventListener('click', () =>
				handleGeneratePlan(day, absentTeachers));
			document.getElementById('reset-plan-btn').addEventListener('click', () =>
				handleResetPlan(day));
		}
		function handleSubDayChange(newDay) {
			const selectedCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
			const absentTeachers = selectedCheckboxes.map(cb => cb.value);
			renderSubstitutionView(newDay, absentTeachers);
		}
		function handleAbsentTeacherChange(checkbox) {
			const day = document.getElementById('sub-day-select').value;
			const selectedCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
			const absentTeachers = selectedCheckboxes.map(cb => cb.value);
			renderSubstitutionView(day, absentTeachers);
		}

		// --- VIEW SWITCHING ---
		function switchView(view) {
			// Clear intervals
			if (window.dashboardInterval) {
				clearInterval(window.dashboardInterval);
				window.dashboardInterval = null;
			}

			state.currentView = view;
			
			// Update navigation
			document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
			const activeBtn = document.getElementById(`nav-${view}`);
			if (activeBtn) activeBtn.classList.add('active');

			// Render view
			switch(view) {
				case 'Dashboard':
					renderDashboard();
					break;
				case 'Day':
					renderDayView();
					break;
				case 'Substitution':
					renderSubstitutionView();
					break;
				case 'Class':
					renderClassView();
					break;
				case 'Teacher':
					renderTeacherView();
					break;
				default:
					renderDashboard();
			}
		}

		// --- SUBSTITUTION MANAGEMENT ---
		function handleGeneratePlan(day, absentTeachers) {
			try {
				if (!day || !absentTeachers || absentTeachers.length === 0) {
					showToast('⚠️ Please select at least one absent teacher', 3000, 'warning');
					return;
				}

				const { teacherDetails, timetable } = state.allData;
				const vacantSlots = [];

				// Find all slots that need substitution
				absentTeachers.forEach(teacher => {
					const schedule = teacherDetails[teacher]?.schedule[day];
					if (schedule) {
						schedule.forEach((period, periodIndex) => {
							if (period) {
								vacantSlots.push({
									...period,
									periodIndex,
									originalTeacher: teacher
								});
							}
						});
					}
				});

				// Initialize substitution structure if needed
				if (!state.substitutions[day]) {
					state.substitutions[day] = { plan: {}, absentTeachers: [] };
				}
				state.substitutions[day].absentTeachers = [...absentTeachers];
				
				// Clear existing plan for these slots
				vacantSlots.forEach(slot => {
					if (!state.substitutions[day].plan[slot.className]) {
						state.substitutions[day].plan[slot.className] = {};
					}
					delete state.substitutions[day].plan[slot.className][slot.periodIndex];
				});

				// Generate new plan
				const newPlan = state.substitutions[day].plan;
				vacantSlots.forEach(slot => {
					const freeTeachers = findFreeTeachers(
						day, 
						slot.periodIndex, 
						absentTeachers, 
						newPlan
					);
					
					if (freeTeachers.length > 0) {
						if (!newPlan[slot.className]) {
							newPlan[slot.className] = {};
						}
						newPlan[slot.className][slot.periodIndex] = freeTeachers[0];
					}
				});

				// Save updated plan
				state.substitutions[day].plan = newPlan;
				showToast('✅ Substitution plan generated successfully!', 3000, 'success');
				renderSubstitutionView(day, absentTeachers);
				
			} catch (error) {
				console.error('Error generating substitution plan:', error);
				showToast('❌ Failed to generate substitution plan', 3000, 'error');
			}
		}

		function handleResetPlan(day) {
			try {
				if (!day) {
					showToast('⚠️ No day selected', 3000, 'warning');
					return;
				}

				if (!state.substitutions[day] || !state.substitutions[day].plan) {
					showToast('ℹ️ No substitution plan exists for this day', 3000, 'info');
					return;
				}

				const confirmReset = confirm(`Are you sure you want to reset the substitution plan for ${day}?`);
				if (!confirmReset) return;

				const absentTeachers = state.substitutions[day].absentTeachers || [];
				state.substitutions[day] = { plan: {}, absentTeachers };
				
				showToast('✅ Substitution plan reset successfully', 3000, 'success');
				renderSubstitutionView(day, absentTeachers);
				
			} catch (error) {
				console.error('Error resetting substitution plan:', error);
				showToast('❌ Failed to reset substitution plan', 3000, 'error');
			}
		}

		function handleShareScreenshot() {
			try {
				const captureElement = document.getElementById('print-capture-area');
				const content = document.getElementById('main-content');
				
				// Prepare capture area
				const prevCapture = captureElement.style.display;
				document.getElementById('print-content').innerHTML = content.innerHTML;
				captureElement.style.display = 'block';
				
				html2canvas(captureElement).then(canvas => {
					captureElement.style.display = prevCapture;
					canvas.toBlob(blob => {
						try {
							const file = new File([blob], 'timetable.png', { type: 'image/png' });
							
							// Check if Web Share API is available
							if (navigator.share) {
								navigator.share({
									files: [file],
									title: 'Veer Patta Public School Timetable',
								}).catch(err => {
									console.error('Share failed:', err);
									showToast('⚠️ Sharing failed. Image downloaded instead.', 3000, 'warning');
									// Fallback to download
									const url = URL.createObjectURL(blob);
									const a = document.createElement('a');
									a.href = url;
									a.download = 'timetable.png';
									a.click();
									URL.revokeObjectURL(url);
								});
							} else {
								// If Web Share API is not available, download the image
								const url = URL.createObjectURL(blob);
								const a = document.createElement('a');
								a.href = url;
								a.download = 'timetable.png';
								a.click();
								URL.revokeObjectURL(url);
								showToast('✅ Timetable image downloaded', 3000, 'success');
							}
						} catch (error) {
							console.error('Error sharing/downloading:', error);
							showToast('❌ Failed to share/download image', 3000, 'error');
						}
					});
				});
			} catch (error) {
				console.error('Screenshot error:', error);
				showToast('❌ Failed to capture screenshot', 3000, 'error');
			}
		}

		function handleShareSubstitutionWhatsApp(day) {
			try {
				const daySubsData = state.substitutions[day]?.plan || {};
				const { periodHeaders, teacherDetails } = state.allData;
				const absentTeachers = state.substitutions[day]?.absentTeachers || [];
				
				if (Object.keys(daySubsData).length === 0) {
					showToast('⚠️ No substitution plan available to share', 3000, 'warning');
					return;
				}

				// Build formatted text
				let message = `📋 *Substitution Plan - ${day}*\n`;
				message += `Veer Patta Public School\n\n`;
				
				// Group by class
				const classPlan = {};
				absentTeachers.forEach(absentTeacher => {
					const schedule = teacherDetails[absentTeacher]?.schedule[day];
					if (schedule) {
						schedule.forEach((period, periodIndex) => {
							if (period) {
								const substitute = daySubsData[period.className]?.[periodIndex];
								if (substitute) {
									if (!classPlan[period.className]) {
										classPlan[period.className] = [];
									}
									classPlan[period.className].push({
										period: periodHeaders[periodIndex].name,
										subject: period.subject,
										originalTeacher: absentTeacher,
										substitute: substitute
									});
								}
							}
						});
					}
				});

				// Format the message
				for (const [className, periods] of Object.entries(classPlan)) {
					message += `*${className}*\n`;
					periods.forEach(p => {
						message += `${p.period}: ${p.subject}\n`;
						message += `Teacher: ${p.substitute} (for ${p.originalTeacher})\n\n`;
					});
				}

				// Encode and open WhatsApp
				const encodedMessage = encodeURIComponent(message);
				const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
				window.open(whatsappUrl, '_blank');
				showToast('✅ Opening WhatsApp...', 3000, 'success');
			} catch (error) {
				console.error('Error sharing via WhatsApp:', error);
				showToast('❌ Failed to share via WhatsApp', 3000, 'error');
			}
		}

		function handleDownloadSubstitutionImage(day) {
			try {
				const planContent = document.getElementById('substitution-plan-content');
				if (!planContent) {
					showToast('⚠️ No substitution plan available to download', 3000, 'warning');
					return;
				}

				const captureElement = document.getElementById('print-capture-area');
				const prevCapture = captureElement.style.display;
				document.getElementById('print-header-subtitle').textContent = `Substitution Plan for ${day}`;
				document.getElementById('print-content').innerHTML = planContent.innerHTML;
				captureElement.style.display = 'block';
				
				html2canvas(captureElement).then(canvas => {
					captureElement.style.display = prevCapture;
					canvas.toBlob(blob => {
						try {
							const url = URL.createObjectURL(blob);
							const a = document.createElement('a');
							a.href = url;
							a.download = `substitution-plan-${day}.png`;
							a.click();
							URL.revokeObjectURL(url);
							showToast('✅ Substitution plan image downloaded', 3000, 'success');
						} catch (error) {
							console.error('Error downloading:', error);
							showToast('❌ Failed to download image', 3000, 'error');
						}
					});
				});
			} catch (error) {
				console.error('Screenshot error:', error);
				showToast('❌ Failed to capture screenshot', 3000, 'error');
			}
		}

		// --- INITIALIZATION FUNCTION ---
		async function init() {
			try {
				// Parse data
				state.allData = parseTimetableData();
				console.log('Initialized with data:', state.allData.days);
				
				// Initialize substitutions structure
				state.allData.days.forEach(day => {
					if (!state.substitutions[day]) {
						state.substitutions[day] = { plan: {}, absentTeachers: [] };
					}
				});
				
				// Render initial view
				switchView('Dashboard');
				
				// Set up toast style
				const style = document.createElement('style');
				style.innerHTML = `
				.toast-notification {
					position: fixed;
					top: 20px;
					right: 20px;
					z-index: 10000;
					background: var(--primary-600);
					color: white;
					padding: 0.75rem 1rem;
					border-radius: var(--radius);
					box-shadow: var(--shadow-lg);
					transition: all 0.3s ease;
					font-size: 0.875rem;
					font-weight: 500;
					max-width: 300px;
					opacity: 1;
				}
				.toast-notification.error {
					background: var(--red-500);
				}
				.toast-notification.success {
					background: var(--green-500);
				}
				.toast-notification.warning {
					background: var(--yellow-500);
				}
				@keyframes pulse {
					0%, 100% { opacity: 1; }
					50% { opacity: .5; }
				}
			`;
			document.head.appendChild(style);
			
			// Hide loader after a delay for smoother UX
			setTimeout(() => {
				const loader = document.getElementById('loader');
				loader.style.opacity = '0';
				setTimeout(() => {
					loader.style.display = 'none';
				}, 300);

				// Add keyboard shortcuts
				document.addEventListener('keydown', (e) => {
					if (e.altKey) {
						switch(e.key) {
							case '1': switchView('Dashboard'); break;
							case '2': switchView('Day'); break;
							case '3': switchView('Substitution'); break;
							case '4': switchView('Class'); break;
							case '5': switchView('Teacher'); break;
						}
					}
				});

				showToast('📚 Timetable Command Center loaded successfully!', 2000, 'success');
			}, 300);
			
			} catch (error) {
				console.error('Initialization error:', error);
				showToast('❌ Failed to load timetable data', 5000, 'error');
				
				// Show fallback content
				mainContent.innerHTML = `
				<div class="card">
					<div style="color: var(--red-500); padding: 2rem; text-align: center;">
						<i data-lucide="alert-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i><br>
						<h3>Initialization Error</h3>
						<p>Failed to load the timetable application. Please refresh the page.</p>
						<button onclick="window.location.reload()" class="button button-primary" style="margin-top: 1rem; max-width: 200px;">
							Reload Page
						</button>
					</div>
				</div>
				`;
				lucide.createIcons();
			}
		}

		// Initialize app when window loads
		window.onload = init;
	</script>
</body>
</html>
