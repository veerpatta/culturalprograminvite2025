<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timetable Command Center - Veer Patta Public School</title>

<!-- LIBRARIES (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>

<!-- FONTS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- STYLES -->
<style>
/* CSS Variables for Theme */
:root {
    --primary-50: #eff6ff;
    --primary-100: #dbeafe;
    --primary-200: #bfdbfe;
    --primary-300: #93c5fd;
    --primary-400: #60a5fa;
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --primary-800: #1e40af;
    --primary-900: #1e3a8a;

    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;

    --green-500: #10b981;
    --yellow-500: #f59e0b;
    --red-500: #ef4444;
    --red-600: #dc2626;

    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

    --radius: 0.5rem;
    --radius-lg: 0.75rem;
}

/* Global Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, var(--primary-50) 0%, var(--gray-50) 100%);
    color: var(--gray-900);
    min-height: 100vh;
    line-height: 1.6;
}

/* Loading Screen */
#loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.3s ease;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid var(--gray-200);
    border-top-color: var(--primary-600);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* App Container */
.app-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
}

/* Header */
header {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-md);
    text-align: center;
}

header h1 {
    font-size: 1.875rem;
    font-weight: 800;
    color: var(--primary-800);
    margin-bottom: 0.25rem;
}

header p {
    color: var(--gray-600);
    font-size: 0.875rem;
}

/* Navigation */
nav {
    background: white;
    border-radius: var(--radius-lg);
    padding: 0.75rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    scrollbar-width: thin;
}

nav::-webkit-scrollbar {
    height: 6px;
}

nav::-webkit-scrollbar-thumb {
    background: var(--gray-300);
    border-radius: 3px;
}

.nav-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    background: transparent;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    color: var(--gray-700);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
}

.nav-button:hover {
    background: var(--primary-50);
    border-color: var(--primary-300);
    color: var(--primary-700);
    transform: translateY(-1px);
}

.nav-button.active {
    background: var(--primary-600);
    border-color: var(--primary-600);
    color: white;
    box-shadow: var(--shadow-md);
}

.nav-button svg {
    width: 18px;
    height: 18px;
}

/* Main Content */
.main-content {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Cards */
.card {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
}

/* Stat Cards */
.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.stat-card-icon {
    width: 50px;
    height: 50px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}

.stat-card-icon svg {
    width: 24px;
    height: 24px;
}

.stat-card-label {
    font-size: 0.75rem;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-card-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
}

/* Tables */
.table-container {
    overflow-x: auto;
    margin: 1rem -0.5rem;
    padding: 0 0.5rem;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

th {
    background: var(--gray-50);
    color: var(--gray-700);
    font-weight: 600;
    text-align: left;
    padding: 0.75rem;
    border-bottom: 2px solid var(--gray-200);
    position: sticky;
    top: 0;
    z-index: 10;
}

td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--gray-100);
    vertical-align: top;
}

tr:hover {
    background: var(--primary-50);
}

.subject {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.125rem;
}

.teacher {
    font-size: 0.75rem;
    color: var(--gray-600);
}

.substitute {
    color: var(--primary-600);
    font-weight: 500;
}

.line-through {
    text-decoration: line-through;
    opacity: 0.5;
}

.class-name {
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-top: 0.125rem;
}

/* Form Elements */
select {
    width: 100%;
    padding: 0.625rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius);
    background: white;
    font-size: 0.875rem;
    color: var(--gray-700);
    cursor: pointer;
    transition: border-color 0.2s;
}

select:hover {
    border-color: var(--primary-400);
}

select:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Buttons */
.button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    border-radius: var(--radius);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    width: 100%;
}

.button svg {
    width: 18px;
    height: 18px;
}

.button-primary {
    background: var(--primary-600);
    color: white;
}

.button-primary:hover {
    background: var(--primary-700);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.button-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

.button-secondary:hover {
    background: var(--gray-200);
    transform: translateY(-1px);
}

.button-danger {
    background: var(--red-500);
    color: white;
}

.button-danger:hover {
    background: var(--red-600);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.button-whatsapp {
    background: #25D366;
    color: white;
}

.button-whatsapp:hover {
    background: #1DA851;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

/* Footer */
footer {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--gray-600);
    font-size: 0.875rem;
}

/* Mobile Menu Button */
.mobile-menu-btn {
    display: none;
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--primary-600);
    color: white;
    border: none;
    box-shadow: var(--shadow-lg);
    z-index: 100;
    cursor: pointer;
    transition: all 0.3s;
}

.mobile-menu-btn:hover {
    transform: scale(1.1);
    background: var(--primary-700);
}

.mobile-menu-btn svg {
    width: 24px;
    height: 24px;
}

/* Utility Classes */
.grid {
    display: grid;
}

.grid-cols-1 {
    grid-template-columns: repeat(1, minmax(0, 1fr));
}

.gap-4 {
    gap: 1rem;
}

.gap-6 {
    gap: 1.5rem;
}

.mb-4 {
    margin-bottom: 1rem;
}

.mt-4 {
    margin-top: 1rem;
}

.flex {
    display: flex;
}

.flex-wrap {
    flex-wrap: wrap;
}

.items-center {
    align-items: center;
}

.justify-between {
    justify-content: space-between;
}

.justify-center {
    justify-content: center;
}

.font-bold {
    font-weight: 700;
}

.block {
    display: block;
}

/* Print Styles */
@media print {
    body {
        background: white;
    }

    .no-print {
        display: none !important;
    }

    .app-container {
        max-width: 100%;
        padding: 0;
    }

    .card {
        box-shadow: none;
        border: 1px solid var(--gray-300);
        page-break-inside: avoid;
    }

    table {
        font-size: 10pt;
    }

    #print-capture-area {
        display: block !important;
    }
}

#print-capture-area {
    position: absolute;
    left: -9999px;
    width: 1200px;
}

#print-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--gray-200);
}

#print-header img {
    height: 60px;
}

#print-header-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
}

#print-header-subtitle {
    font-size: 1rem;
    color: var(--gray-600);
    text-align: center;
    margin-bottom: 1rem;
}

/* Responsive Design */
@media (min-width: 768px) {
    .grid-cols-md-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

@media (max-width: 768px) {
    header h1 {
        font-size: 1.5rem;
    }

    .app-container {
        padding: 0.75rem;
    }

    .card {
        padding: 1rem;
        border-radius: var(--radius);
    }

    nav {
        padding: 0.5rem;
        margin-bottom: 1rem;
    }

    .nav-button {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }

    .nav-button span {
        display: none;
    }

    .nav-button svg {
        width: 20px;
        height: 20px;
    }

    .stat-grid {
        grid-template-columns: 1fr;
    }

    table {
        font-size: 0.75rem;
    }

    th, td {
        padding: 0.5rem;
    }

    .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .button {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
    }
}

@media (max-width: 480px) {
    header h1 {
        font-size: 1.25rem;
    }

    header p {
        font-size: 0.75rem;
    }

    .stat-card {
        padding: 1rem;
    }

    .stat-card-icon {
        width: 40px;
        height: 40px;
    }

    .stat-card-value {
        font-size: 1.25rem;
    }

    table {
        font-size: 0.7rem;
    }

    th, td {
        padding: 0.375rem;
    }
}

/* Accessibility */
:focus-visible {
    outline: 2px solid var(--primary-500);
    outline-offset: 2px;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* Toast Notification */
.toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    background: var(--gray-900);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow-xl);
    z-index: 1000;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        transform: translate(-50%, 100%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

/* Loading State */
.skeleton {
    background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: var(--radius);
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}
</style>
</head>
<body>
<div id="loader">
    <div class="spinner"></div>
</div>

<div id="print-capture-area" style="display: none; background: white; padding: 1.5rem;">
    <div id="print-header">
        <img src="logo.png" alt="Veer Patta Public School Logo">
        <h1 id="print-header-title">Veer Patta Public School - Timetable</h1>
    </div>
    <h2 id="print-header-subtitle"></h2>
    <div id="print-content"></div>
</div>

<div class="app-container">
    <header class="no-print">
        <h1>üìö Timetable Command Center</h1>
        <p>Veer Patta Public School, Amet</p>
    </header>

    <nav class="no-print" id="main-nav">
        <button id="nav-Dashboard" class="nav-button active" onclick="switchView('Dashboard')">
            <i data-lucide="layout-dashboard"></i>
            <span>Dashboard</span>
        </button>
        <button id="nav-Day" class="nav-button" onclick="switchView('Day')">
            <i data-lucide="calendar-days"></i>
            <span>Day View</span>
        </button>
        <button id="nav-Substitution" class="nav-button" onclick="switchView('Substitution')">
            <i data-lucide="user-cog"></i>
            <span>Substitutions</span>
        </button>
        <button id="nav-Class" class="nav-button" onclick="switchView('Class')">
            <i data-lucide="school"></i>
            <span>Class View</span>
        </button>
        <button id="nav-Teacher" class="nav-button" onclick="switchView('Teacher')">
            <i data-lucide="users"></i>
            <span>Teacher View</span>
        </button>
    </nav>

    <main id="main-content" class="main-content"></main>

    <footer class="no-print">
        <p>¬© 2025 Veer Patta Public School | Developed with ‚ù§Ô∏è</p>
    </footer>
</div>

<!-- Mobile Quick Access Button -->
<button class="mobile-menu-btn no-print" onclick="scrollToTop()">
    <i data-lucide="arrow-up"></i>
</button>

<script>
// --- DATA STORE ---
const rawData = `Monday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,EVS (Bindu),EVS (Bindu),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Hindi (Bindu),Home Work (Anjana),Maths (Kusum)
Class 2,Maths (Anita),Maths (Anita),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),Hindi (Bindu),Hindi (Bindu)
Class 3,EVS (Rashmita),EVS (Rashmita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Hindi (Kusum),Hindi (Kusum),Sports (Rakesh)
Class 4,Hindi (Kusum),Home Work (Jainendra),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),EVS (Anita),EVS (Anita),Sports (Rakesh)
Class 5,Maths (Nidhika),Hindi (Kusum),ELGA (Anita),ELGA (Anita),ELGA (Anita),CCS (Maya),Maths (Nidhika),EVS (Nidhika)
Class 6,Science (Hemlata),Science (Hemlata),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),SST (Rashmita),Hindi (Jainendra)
Class 7,Hindi (Jainendra),Maths (Leena),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Prakash),Maths (Leena),Science (Hemlata)
Class 8,Hindi (Antima),CCS (Maya),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Science (Hemlata),Sanskrit (Antima)
Class 9,Maths (Leena),SST (Pradhyuman),Science (Toshit),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra),English (Harshita),Maths (Leena)
Class 10,SST (Pradhyuman),Hindi (Antima),Maths (Nathulal),Maths (Nathulal),Sanskrit (Antima),English (Harshita),Science (Toshit),Sports (Rakesh)
Class 11 Science,Physics (Phy),Physics (Phy),Biology (Hemlata),English (Pradhyuman),Chemistry (Toshit),Chemistry (Toshit),English (Pradhyuman),Sports (Rakesh)
Class 11 Commerce,Self Study (Maya),Business (Nidhika),Economics (Prakash),English (Pradhyuman),Accountancy (Nathulal),Accountancy (Nathulal),English (Pradhyuman),Accountancy (Nathulal)
Class 11 Arts,English Literature (Harshita),Geography (Prakash),Economics (Prakash),English (Pradhyuman),CCS (Maya),Sports (Rakesh),English (Pradhyuman),Political Science (Pradhyuman)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy),Physics (Phy),English (Pradhyuman),Biology (Hemlata),Hindi (Jainendra),Physics (Phy)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Business (Pradhyuman),Economics (Prakash),English (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),CCS (Maya)
Class 12 Arts,Geography (Prakash),English Literature (Harshita),Hindi Boards (Antima),Economics (Prakash),English (Pradhyuman),Political Science (Pradhyuman),Hindi (Jainendra),English Literature (Harshita)

Tuesday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,EVS (Bindu),Maths (Kusum),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Hindi (Bindu),Hindi (Bindu),Home Work (Anjana)
Class 2,Maths (Anita),Hindi (Bindu),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),EVS (Rashmita),Hindi (Bindu)
Class 3,EVS (Rashmita),Maths (Anita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Maths (Anita),Hindi (Kusum),Hindi (Kusum)
Class 4,Hindi (Kusum),Maths (Leena),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),Basic Hindi (Anjana),EVS (Anita),EVS (Anita)
Class 5,EVS (Nidhika),Home Work (Rashmita),ELGA (Anita),ELGA (Anita),ELGA (Anita),Hindi (Kusum),Maths (Nidhika),EVS (Nidhika)
Class 6,Science (Hemlata),Sanskrit (Jainendra),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),Hindi (Jainendra),SST (Rashmita)
Class 7,Hindi (Jainendra),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Prakash),Maths (Leena),Sanskrit (Antima)
Class 8,Hindi (Antima),Sanskrit (Antima),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Science (Hemlata),SST (Harshita)
Class 9,Maths (Leena),English (Harshita),Hindi (Jainendra),CCS (Maya),Science (Toshit),Science (Toshit),Sanskrit (Antima),SST (Pradhyuman)
Class 10,SST (Pradhyuman),CCS (Maya),Maths (Nathulal),Sanskrit (Antima),Hindi (Antima),English (Harshita),Science (Toshit),Maths (Nathulal)
Class 11 Science,Physics (Phy),Physics (Phy),Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
Class 11 Commerce,Self Study (Maya),Business (Nidhika),Economics (Prakash),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
Class 11 Arts,English Literature (Harshita),Political Science (Pradhyuman),Economics (Prakash),Geography (Prakash),CCS (Maya),Hindi (Jainendra),English (Pradhyuman),Hindi (Jainendra)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Biology (Hemlata),Hindi (Jainendra),english (Pradhyuman),Physics (Phy),Biology (Hemlata)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),CCS (Maya),Business (Pradhyuman),Hindi (Jainendra),English (Pradhyuman),Accountancy (Nathulal),Sports (Rakesh)
Class 12 Arts,Geography (Prakash),Geography (Prakash),Political Science (Pradhyuman),Hindi (Jainendra),Hindi (Jainendra),English (Pradhyuman),English Literature (Harshita),Sports (Rakesh)

Wednesday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,EVS (Bindu),Maths (Kusum),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),Home Work (Anjana),Hindi (Bindu),Sports (Rakesh)
Class 2,Maths (Anita),Hindi (Bindu),ELGA (Leena),ELGA (Leena),ELGA (Leena),Hindi (Bindu),EVS (Rashmita),Sports (Rakesh)
Class 3,EVS (Rashmita),Home Work (Jainendra),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Maths (Anita),Maths (Anita),Maths (Anita)
Class 4,Hindi (Kusum),EVS (Anita),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),Maths (Leena),Maths (Leena),Hindi (Kusum)
Class 5,EVS (Nidhika),EVS (Nidhika),ELGA (Anita),ELGA (Anita),ELGA (Anita),Hindi (Kusum),Hindi (Kusum),Maths (Nidhika)
Class 6,Science (Hemlata),SST (Rashmita),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Maths (Nidhika),Science (Hemlata),CCS (Maya)
Class 7,Hindi (Jainendra),Sanskrit (Antima),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Science (Hemlata),CCS (Maya),SST (Prakash)
Class 8,Sanskrit (Antima),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),English Boards (Rashmita),SST (Harshita),Maths (Leena)
Class 9,Maths (Leena),Maths (Leena),Hindi (Jainendra),Science (Toshit),Sports (Rakesh),Sanskrit (Antima),SST (Pradhyuman),English (Harshita)
Class 10,SST (Pradhyuman),English (Harshita),Science (Toshit),Maths (Nathulal),Sanskrit (Antima),Science (Toshit),Hindi (Antima),Maths (Nathulal)
Class 11 Science,Physics (Phy),Physics (Phy),English (Pradhyuman),Biology (Hemlata),Biology (Hemlata),Sports (Rakesh),Chemistry (Toshit),Chemistry (Toshit)
Class 11 Commerce,CCS (Maya),Economics (Prakash),English (Pradhyuman),Self Study (Maya),Accountancy (Nathulal),Accountancy (Nathulal),Business (Nidhika),Sports (Rakesh)
Class 11 Arts,English Literature (Harshita),Economics (Prakash),English (Pradhyuman),Geography (Prakash),Self Study (Toshit),Political Science (Pradhyuman),Sports (Rakesh),Sports (Rakesh)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),Hindi (Jainendra)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),English (Pradhyuman),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra)
Class 12 Arts,Geography (Prakash),Political Science (Pradhyuman),Economics (Prakash),Hindi (Jainendra),English (Pradhyuman),English Literature (Harshita),Hindi (Jainendra),Hindi (Jainendra)

Thursday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,Hindi (Bindu),EVS (Bindu),ELGA (Bindu),ELGA (Bindu),ELGA (Bindu),EVS (Bindu),CCS (Maya),Hindi (Anjana)
Class 2,Maths (Anita),Maths (Anita),ELGA (Leena),ELGA (Leena),ELGA (Leena),EVS (Rashmita),EVS (Rashmita),Hindi (Bindu)
Class 3,EVS (Rashmita),EVS (Rashmita),ELGA (Kusum),ELGA (Kusum),ELGA (Kusum),Hindi (Kusum),Home Work (Bindu),Maths (Anita)
Class 4,Hindi (Kusum),CCS (Maya),ELGA (Rashmita),ELGA (Rashmita),ELGA (Rashmita),EVS (Anita),EVS (Anita),Games (Rakesh)
Class 5,EVS (Nidhika),Hindi (Kusum),ELGA (Anita),ELGA (Anita),ELGA (Anita),Home work (Anjana),Maths (Nidhika),Hindi (Kusum)
Class 6,Science (Hemlata),Maths (Nidhika),ELGA (Nidhika),ELGA (Nidhika),ELGA (Nidhika),Hindi (Jainendra),Science (Hemlata),SST (Rashmita)
Class 7,Hindi (Jainendra),Science (Hemlata),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),SST (Prakash),Sanskrit (Antima),Maths (Leena)
Class 8,Hindi (Antima),SST (Harshita),ELGA (Harshita),ELGA (Harshita),ELGA (Harshita),Maths (Leena),Maths (Leena),Science (Hemlata)
Class 9,Maths (Leena),Hindi (Jainendra),SST (Pradhyuman),SST (Pradhyuman),Sanskrit (Antima),Sanskrit (Antima),Science (Toshit),Science (Toshit)
Class 10,SST (Pradhyuman),SST (Pradhyuman),Science (Toshit),Science (Toshit),Maths (Nathulal),Maths (Nathulal),English (Harshita),Sanskrit (Antima)
Class 11 Science,Physics (Phy),Physics (Phy),Biology (Hemlata),Biology (Hemlata),Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),English (Pradhyuman)
Class 11 Commerce,CCS (Maya),Economics (Prakash),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Business (Nidhika),Hindi (Jainendra),English (Pradhyuman)
Class 11 Arts,English Literature (Harshita),Economics (Prakash),Geography (Prakash),Self Study (Antima),Political Science (Pradhyuman),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),Physics (Phy),Biology (Hemlata),Biology (Hemlata),English (Pradhyuman),Hindi (Jainendra)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Economics (Prakash),Sports (Rakesh),Business (Pradhyuman),English (Pradhyuman),Hindi (Jainendra)
Class 12 Arts,Geography (Prakash),Self Study (Antima),Hindi (Jainendra),Economics (Prakash),Sports (Rakesh),CCS (Maya),Hindi (Jainendra),Hindi (Jainendra)

Friday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,Hindi (Bindu),Hindi (Bindu),Maths (Kusum),EVS (Bindu),Maths (Kusum),CCS (Maya),EVS (Bindu),EVS (Bindu)
Class 2,Maths (Anita),Maths (Anita),Hindi (Bindu),EVS (Rashmita),Hindi (Bindu),Hindi (Bindu),CCS (Maya),EVS (Rashmita)
Class 3,EVS (Rashmita),EVS (Rashmita),Maths (Anita),Maths (Anita),CCS (Maya),Hindi (Kusum),Hindi (Kusum),Home Work (Anjana)
Class 4,Hindi (Kusum),Hindi (Kusum),Home Work (Rashmita),CCS (Maya),Maths (Leena),Maths (Leena),EVS (Anita),EVS (Anita)
Class 5,EVS (Nidhika),EVS (Nidhika),Basic Hindi (Antima),Hindi (Kusum),Maths (Nidhika),Maths (Nidhika),Home Work (Anjana),Sports (Rakesh)
Class 6,Science (Hemlata),Sanskrit (Jainendra),Maths (Nidhika),Maths (Nidhika),Sanskrit (Jainendra),SST (Rashmita),SST (Rashmita),Sports (Rakesh)
Class 7,Hindi (Jainendra),Maths (Leena),Maths (Leena),Science (Hemlata),Science (Hemlata),Sanskrit (Antima),SST (Prakash),SST (Prakash)
Class 8,Hindi (Antima),Science (Hemlata),Science (Hemlata),Maths (Leena),Sports (Rakesh),SST (Harshita),SST (Harshita),Sanskrit (Antima)
Class 9,Maths (Leena),SST (Pradhyuman),Science (Toshit),Sanskrit (Antima),English (Harshita),Hindi (Jainendra),Sports (Rakesh),CCS (Maya)
Class 10,SST (Pradhyuman),Sanskrit (Antima),Maths (Nathulal),English (Harshita),Hindi (Antima),Science (Toshit),Sports (Rakesh),English (Harshita)
Class 11 Science,Physics (Phy),Physics (Phy),Hindi (Jainendra),Chemistry (Toshit),Chemistry (Toshit),English (Pradhyuman),Biology (Hemlata),Biology (Hemlata)
Class 11 Commerce,Self Study (Maya),Economics (Prakash),Hindi (Jainendra),Accountancy (Nathulal),Accountancy (Nathulal),English (Pradhyuman),Business (Nidhika),Business (Nidhika)
Class 11 Arts,English Literature (Harshita),Economics (Prakash),Hindi (Jainendra),Geography (Prakash),Political Science (Pradhyuman),English (Pradhyuman),Sports (Rakesh),Sports (Rakesh)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy),Physics (Phy),Sports (Rakesh),Biology (Hemlata),English (Pradhyuman),Hindi (Jainendra)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),Sports (Rakesh),Accountancy (Nathulal),English (Pradhyuman),Hindi (Jainendra)
Class 12 Arts,Geography (Prakash),English Literature (Harshita),Economics/Political Science (Prakash/Pradhyuman),Self Study (Jainendra),Sports (Rakesh),Sports (Rakesh),English (Pradhyuman),Hindi (Jainendra)

Saturday
Class,Period 1<br>8:30 AM - 9:10 AM,Period 2<br>9:10 AM - 9:50 AM,Period 3<br>9:50 AM - 10:30 AM,Period 4<br>10:30 AM - 11:10 AM,Period 5<br>11:30 AM - 12:10 PM,Period 6<br>12:10 PM - 12:50 PM,Period 7<br>12:50 PM - 01:30 PM,Period 8<br>01:30 PM - 02:10 PM
Class 1,EVS (Bindu),EVS (Bindu),Hindi (Bindu),Hindi (Bindu),Sports (Rakesh),Maths (Kusum),Home Work (Anjana),Home Work (Bindu)
Class 2,Maths (Anita),EVS (Rashmita),EVS (Rashmita),EVS (Rashmita),Sports (Rakesh),CCS (Maya),Hindi (Bindu),Home Work (Anita)
Class 3,EVS (Rashmita),Maths (Anita),Hindi (Kusum),Hindi (Kusum),EVS (Rashmita),Home Work (Anjana),CCS (Maya),Home Work (Rashmita)
Class 4,Hindi (Kusum),Hindi (Kusum),EVS (Anita),EVS (Anita),Home Work (Anjana),Maths (Leena),Maths (Leena),Maths (Leena)
Class 5,Maths (Nidhika),Maths (Nidhika),CCS (Maya),EVS (Nidhika),EVS (Nidhika),Sports (Rakesh),Hindi (Kusum),Home Work (Anjana)
Class 6,Science (Hemlata),Hindi (Jainendra),Maths (Nidhika),CCS (Maya),Sanskrit (Jainendra),Maths (Nidhika),SST (Rashmita),Hindi (Jainendra)
Class 7,Hindi (Jainendra),Science (Hemlata),Science (Hemlata),Maths (Leena),SST (Prakash),English Basic (Rashmita),SST (Prakash),Sports (Rakesh)
Class 8,Hindi (Antima),Sanskrit (Antima),Maths (Leena),Science (Hemlata),CCS (Maya),SST (Harshita),SST (Harshita),Sports (Rakesh)
Class 9,Maths (Leena),Maths (Leena),Science (Toshit),Hindi (Jainendra),Maths (Leena),SST (Pradhyuman),Science (Toshit),English (Harshita)
Class 10,SST (Pradhyuman),SST (Pradhyuman),Maths (Nathulal),Sanskrit (Antima),English (Harshita),Science (Toshit),SST (Pradhyuman),Hindi (Antima)
Class 11 Science,Physics (Phy),Physics (Phy),Hindi (Jainendra),Chemistry (Toshit),Chemistry (Toshit),Hindi (Jainendra),Biology (Hemlata),Sports (Rakesh)
Class 11 Commerce,Self Study (Maya),Economics (Prakash),Hindi (Jainendra),Accountancy (Nathulal),Accountancy (Nathulal),Hindi (Jainendra),Business (Nidhika),Business (Nidhika)
Class 11 Arts,English Literature (Harshita),Economics (Prakash),Hindi (Jainendra),Geography (Prakash),Political Science (Pradhyuman),Hindi (Jainendra),Sports (Rakesh),Sports (Rakesh)
Class 12 Science,Chemistry (Toshit),Chemistry (Toshit),Physics (Phy),Physics (Phy),Biology (Hemlata),Biology (Hemlata),Hindi (Jainendra),English (Pradhyuman)
Class 12 Commerce,Accountancy (Nathulal),Accountancy (Nathulal),Economics (Prakash),Business (Pradhyuman),Sports (Rakesh),Accountancy (Nathulal),Hindi (Jainendra),English (Pradhyuman)
Class 12 Arts,Geography (Prakash),English Literature (Harshita),Economics/Political Science (Prakash/Pradhyuman),English Literature (Harshita),Sports (Rakesh),Sports (Rakesh),Hindi (Jainendra),English (Pradhyuman)`;

// --- GLOBAL STATE & CONSTANTS ---
let state = {
    currentView: 'Dashboard',
    substitutions: {},
    allData: {},
};

const mainContent = document.getElementById('main-content');

// --- DATA PARSING & UTILITY FUNCTIONS ---
const parseTimetableData = () => {
    const timetable = {};
    const teacherDetails = {};
    let headers = [];

    const correctedData = rawData.replace(/\(Nindika\)/g, '(Nidhika)').replace(/\s+Sir/g, '');
    const dayBlocks = correctedData.trim().split(/\n\s*(?=Tuesday|Wednesday|Thursday|Friday|Saturday)/);

    dayBlocks.forEach((block, index) => {
        const lines = block.trim().split('\n');
        const day = lines[0].trim();
        timetable[day] = {};

        if (index === 0) {
            headers = lines[1].split(',').slice(1).map(h => {
                const parts = h.split('<br>');
                return { name: parts[0], time: parts[1] };
            });
        }

        const dataLines = lines.slice(2);
        dataLines.forEach(line => {
            if (!line.trim()) return;
            const columns = line.split(',');
            const className = columns[0].trim();
            timetable[day][className] = [];

            columns.slice(1).forEach((cell, periodIndex) => {
                const match = cell.trim().match(/^(.+?)\s*\(([^)]+)\)$/);
                let entry = { subject: cell.trim(), teacher: null, period: periodIndex, className, day };
                if (match) {
                    entry.subject = match[1].trim();
                    entry.teacher = match[2].trim();
                }
                timetable[day][className].push(entry);

                if (entry.teacher) {
                    const teachersInCell = entry.teacher.split('/').map(t => t.trim());
                    const subjectsInCell = entry.subject.split('/').map(s => s.trim());

                    teachersInCell.forEach((teacherName, i) => {
                        if (!teacherDetails[teacherName]) {
                            teacherDetails[teacherName] = { schedule: {}, periodCount: 0, subjects: new Set() };
                        }
                        if (!teacherDetails[teacherName].schedule[day]) {
                            teacherDetails[teacherName].schedule[day] = Array(headers.length).fill(null);
                        }
                        const subjectForTeacher = subjectsInCell[i] || subjectsInCell[0];
                        teacherDetails[teacherName].schedule[day][periodIndex] = { subject: subjectForTeacher, className };
                        teacherDetails[teacherName].periodCount++;
                        teacherDetails[teacherName].subjects.add(subjectForTeacher);
                    });
                }
            });
        });
    });

    const classNames = Object.keys(timetable.Monday || {}).sort((a,b) => {
        const numA = parseInt(a.match(/\d+/)?.[0]);
        const numB = parseInt(b.match(/\d+/)?.[0]);
        if (!isNaN(numA) && !isNaN(numB) && numA !== numB) return numA - numB;
        return a.localeCompare(b);
    });

    return { timetable, teacherDetails, periodHeaders: headers, classNames, teacherNames: Object.keys(teacherDetails).sort() };
};

// --- UTILITY FUNCTIONS ---
function showToast(message, duration = 3000) {
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.remove(), duration);
}

function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// --- RENDER FUNCTIONS FOR EACH VIEW ---
function renderDashboard() {
    const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
    const { teacherDetails, teacherNames, timetable, classNames } = state.allData;

    const substitutionCount = Object.values(state.substitutions[today]?.plan || {}).reduce((acc, classSubs) =>
        acc + Object.keys(classSubs).length, 0);
    const totalClassesToday = timetable[today] ?
        Object.values(timetable[today]).flat().filter(p => p.teacher).length : 0;

    const html = `
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-card-icon" style="background: var(--primary-500);">
                    <i data-lucide="calendar"></i>
                </div>
                <div>
                    <div class="stat-card-label">Today's Date</div>
                    <div class="stat-card-value">${new Date().toLocaleDateString('en-GB')}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon" style="background: var(--green-500);">
                    <i data-lucide="book-open"></i>
                </div>
                <div>
                    <div class="stat-card-label">Classes Today</div>
                    <div class="stat-card-value">${totalClassesToday}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon" style="background: var(--yellow-500);">
                    <i data-lucide="users"></i>
                </div>
                <div>
                    <div class="stat-card-label">Total Teachers</div>
                    <div class="stat-card-value">${teacherNames.length}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon" style="background: var(--red-500);">
                    <i data-lucide="user-check"></i>
                </div>
                <div>
                    <div class="stat-card-label">Substitutions</div>
                    <div class="stat-card-value">${substitutionCount}</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">
                üîç Live Free Teacher Finder
            </h2>
            <div id="free-teacher-finder-container"></div>
        </div>

        <div class="card">
            <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">
                ‚ö° Quick Actions
            </h2>
            <div class="grid grid-cols-1 grid-cols-md-2 gap-4">
                <button class="button button-primary" onclick="switchView('Day')">
                    <i data-lucide="calendar"></i> View Today's Schedule
                </button>
                <button class="button button-primary" onclick="switchView('Substitution')">
                    <i data-lucide="user-cog"></i> Manage Substitutions
                </button>
                <button class="button button-secondary" onclick="switchView('Class')">
                    <i data-lucide="school"></i> Browse Classes
                </button>
                <button class="button button-secondary" onclick="switchView('Teacher')">
                    <i data-lucide="users"></i> Teacher Schedules
                </button>
            </div>
        </div>
    `;

    mainContent.innerHTML = html;
    renderFreeTeacherFinder();
    lucide.createIcons();
}

function renderFreeTeacherFinder(day = null, period = null) {
    const container = document.getElementById('free-teacher-finder-container');
    if (!container) return;

    const currentDay = day || new Date().toLocaleDateString('en-US', { weekday: 'long' });
    const currentPeriod = period || 1;
    const periodIndex = currentPeriod - 1;

    const freeTeachers = findFreeTeachers(currentDay, periodIndex, [], {});

    const dayOptions = Object.keys(state.allData.timetable).map(d =>
        `<option value="${d}" ${d === currentDay ? 'selected' : ''}>${d}</option>`
    ).join('');

    const periodOptions = state.allData.periodHeaders.map((p, i) =>
        `<option value="${i+1}" ${i+1 == currentPeriod ? 'selected' : ''}>${p.name} (${p.time})</option>`
    ).join('');

    const freeTeachersList = freeTeachers.length > 0
        ? freeTeachers.map(t =>
            `<div style="background: var(--primary-50); color: var(--primary-800); padding: 0.5rem 0.75rem;
                        border-radius: var(--radius); font-size: 0.875rem; font-weight: 500;">
                ${t}
            </div>`
        ).join('')
        : `<div style="color: var(--gray-500); padding: 1rem; text-align: center;">
               No teachers are free for this slot.
           </div>`;

    const html = `
        <div class="grid grid-cols-1 grid-cols-md-2 gap-4 mb-4">
            <select id="finder-day-select">${dayOptions}</select>
            <select id="finder-period-select">${periodOptions}</select>
        </div>
        <div style="max-height: 15rem; overflow-y: auto; padding: 0.5rem;
                    background: var(--gray-50); border-radius: var(--radius);">
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                ${freeTeachersList}
            </div>
        </div>
    `;

    container.innerHTML = html;

    document.getElementById('finder-day-select').addEventListener('change', (e) => {
        renderFreeTeacherFinder(e.target.value, document.getElementById('finder-period-select').value);
    });

    document.getElementById('finder-period-select').addEventListener('change', (e) => {
        renderFreeTeacherFinder(document.getElementById('finder-day-select').value, e.target.value);
    });
}

function renderDayView(day = 'Monday') {
    const { timetable, classNames, periodHeaders } = state.allData;
    const daySubs = state.substitutions[day]?.plan || {};

    const dayButtons = Object.keys(timetable).map(d =>
        `<button class="nav-button ${day === d ? 'active' : ''}" onclick="renderDayView('${d}')">
            ${d}
        </button>`
    ).join('');

    document.getElementById('print-header-subtitle').textContent = `Daily Schedule for ${day}`;

    const tableHeader = '<th>Class</th>' + periodHeaders.map(h =>
        `<th>${h.name}<br/><span style="font-weight:400; font-size: 0.75rem;">${h.time}</span></th>`
    ).join('');

    const tableBody = classNames.map(cName => `
        <tr>
            <td class="font-bold">${cName}</td>
            ${timetable[day][cName].map((period, i) => {
                const substitute = daySubs[cName]?.[i];
                return `
                    <td>
                        <div class="subject">${period.subject}</div>
                        ${period.teacher ? `<div class="teacher ${substitute ? 'line-through' : ''}">${period.teacher}</div>` : ''}
                        ${substitute ? `<div class="teacher substitute">Sub: ${substitute}</div>` : ''}
                    </td>
                `;
            }).join('')}
        </tr>
    `).join('');

    const html = `
        <div class="card">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h2 style="font-size: 1.25rem; font-weight: 700;">üìÖ ${day} Schedule</h2>
                <div class="flex gap-2">
                    <button onclick="handlePrint()" class="button button-secondary" style="width: auto;">
                        <i data-lucide="printer"></i>
                    </button>
                    <button onclick="handleShareScreenshot()" class="button button-whatsapp" style="width: auto;">
                        <i data-lucide="share-2"></i>
                    </button>
                </div>
            </div>
            <div class="flex flex-wrap gap-2" style="border-bottom: 1px solid var(--gray-200);
                 padding-bottom: 0.75rem; margin: 1rem 0;">
                ${dayButtons}
            </div>
            <div class="table-container">
                <table>
                    <thead><tr>${tableHeader}</tr></thead>
                    <tbody>${tableBody}</tbody>
                </table>
            </div>
        </div>
    `;

    mainContent.innerHTML = html;
    lucide.createIcons();
}

function renderClassView(selectedClass = '') {
    const { timetable, classNames, periodHeaders } = state.allData;
    document.getElementById('print-header-subtitle').textContent =
        selectedClass ? `Weekly Schedule for ${selectedClass}` : 'Class Timetables';

    const classOptions = '<option value="">-- Select a Class --</option>' +
        classNames.map(c =>
            `<option value="${c}" ${c === selectedClass ? 'selected' : ''}>${c}</option>`
        ).join('');

    let tableHtml = '';
    if (selectedClass) {
        const tableHeader = '<th>Day</th>' + periodHeaders.map(h =>
            `<th>${h.name}<br/><span style="font-weight:400; font-size: 0.75rem;">${h.time}</span></th>`
        ).join('');

        const tableBody = Object.keys(timetable).map(day => {
            const daySubs = state.substitutions[day]?.plan || {};
            return `
                <tr>
                    <td class="font-bold">${day}</td>
                    ${timetable[day][selectedClass].map((period, i) => {
                        const substitute = daySubs[selectedClass]?.[i];
                        return `
                            <td>
                                <div class="subject">${period.subject}</div>
                                ${period.teacher ? `<div class="teacher ${substitute ? 'line-through' : ''}">${period.teacher}</div>` : ''}
                                ${substitute ? `<div class="teacher substitute">Sub: ${substitute}</div>` : ''}
                            </td>
                        `;
                    }).join('')}
                </tr>
            `;
        }).join('');

        tableHtml = `
            <div class="table-container">
                <table>
                    <thead><tr>${tableHeader}</tr></thead>
                    <tbody>${tableBody}</tbody>
                </table>
            </div>
            <div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
                <button onclick="handlePrint()" class="button button-secondary" style="max-width: 200px;">
                    <i data-lucide="printer"></i> Print
                </button>
                <button onclick="handleShareScreenshot()" class="button button-whatsapp" style="max-width: 200px;">
                    <i data-lucide="share-2"></i> Share
                </button>
            </div>
        `;
    }

    const html = `
        <div class="card">
            <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">
                üè´ View by Class
            </h2>
            <select onchange="renderClassView(this.value)">${classOptions}</select>
            ${tableHtml}
        </div>
    `;

    mainContent.innerHTML = html;
    lucide.createIcons();
}

function renderTeacherView(selectedTeacher = '') {
    const { teacherDetails, teacherNames, periodHeaders, timetable } = state.allData;
    document.getElementById('print-header-subtitle').textContent =
        selectedTeacher ? `Weekly Schedule for ${selectedTeacher}` : 'Teacher Timetables';

    const teacherOptions = '<option value="">-- Select a Teacher --</option>' +
        teacherNames.map(t =>
            `<option value="${t}" ${t === selectedTeacher ? 'selected' : ''}>${t}</option>`
        ).join('');

    let detailsHtml = '';
    if (selectedTeacher) {
        const tableHeader = '<th>Day</th>' + periodHeaders.map(h => `<th>${h.name}</th>`).join('');
        const tableBody = Object.keys(timetable).map(day => {
            const daySchedule = teacherDetails[selectedTeacher].schedule[day] || [];
            const daySubs = state.substitutions[day]?.plan || {};

            return `
                <tr>
                    <td class="font-bold">${day}</td>
                    ${periodHeaders.map((_, i) => {
                        const originalPeriod = daySchedule[i];
                        const isSubstitutedOut = originalPeriod &&
                            daySubs[originalPeriod.className]?.[i];

                        let subPeriodInfo = null;
                        for (const cName in daySubs) {
                            if (daySubs[cName][i] === selectedTeacher) {
                                subPeriodInfo = timetable[day][cName][i];
                                break;
                            }
                        }

                        return `
                            <td>
                                ${originalPeriod ? `
                                    <div class="${isSubstitutedOut ? 'line-through' : ''}">
                                        <div class="subject">${originalPeriod.subject}</div>
                                        <div class="class-name">${originalPeriod.className}</div>
                                    </div>
                                ` : ''}
                                ${subPeriodInfo ? `
                                    <div style="margin-top: 0.25rem;">
                                        <div class="subject substitute">${subPeriodInfo.subject}</div>
                                        <div class="class-name">(Sub for ${subPeriodInfo.teacher})</div>
                                        <div class="class-name">${subPeriodInfo.className}</div>
                                    </div>
                                ` : ''}
                            </td>
                        `;
                    }).join('')}
                </tr>
            `;
        }).join('');

        detailsHtml = `
            <div class="mt-4">
                <div style="background: var(--primary-50); color: var(--primary-800);
                            font-weight: 600; text-align: center; border-radius: var(--radius);
                            padding: 0.75rem; margin-bottom: 1.5rem;">
                    Total Weekly Periods: ${teacherDetails[selectedTeacher].periodCount}
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr>${tableHeader}</tr></thead>
                    <tbody>${tableBody}</tbody>
                </table>
            </div>
            <div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
                <button onclick="handlePrint()" class="button button-secondary" style="max-width: 200px;">
                    <i data-lucide="printer"></i> Print
                </button>
                <button onclick="handleShareScreenshot()" class="button button-whatsapp" style="max-width: 200px;">
                    <i data-lucide="share-2"></i> Share
                </button>
            </div>
        `;
    }

    const html = `
        <div class="card">
            <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">
                üë®‚Äçüè´ View by Teacher
            </h2>
            <select onchange="renderTeacherView(this.value)">${teacherOptions}</select>
            <div id="teacher-details-container">${detailsHtml}</div>
        </div>
    `;

    mainContent.innerHTML = html;
    lucide.createIcons();
}

function renderSubstitutionView(day = 'Monday', absentTeachers = []) {
    const { teacherNames, periodHeaders, teacherDetails } = state.allData;
    document.getElementById('print-header-subtitle').textContent = `Substitution Plan for ${day}`;

    const dayOptions = Object.keys(state.allData.timetable).map(d =>
        `<option value="${d}" ${d === day ? 'selected' : ''}>${d}</option>`
    ).join('');

    const teacherOptionsHtml = teacherNames.map(t => `
        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;
                      border-radius: var(--radius); cursor: pointer; transition: background 0.2s;"
               onmouseover="this.style.backgroundColor='var(--gray-100)'"
               onmouseout="this.style.backgroundColor='transparent'">
            <input type="checkbox" value="${t}" ${absentTeachers.includes(t) ? 'checked' : ''}
                   onchange="handleAbsentTeacherChange(this)">
            <span>${t}</span>
        </label>
    `).join('');

    const daySubsData = state.substitutions[day]?.plan || {};
    const vacantSlots = [];
    absentTeachers.forEach(absentTeacher => {
        const schedule = teacherDetails[absentTeacher]?.schedule[day];
        if (schedule) {
            schedule.forEach((period, periodIndex) => {
                if (period) {
                    vacantSlots.push({ ...period, periodIndex, originalTeacher: absentTeacher });
                }
            });
        }
    });

    const plan = vacantSlots.map(slot => {
        const substitute = daySubsData[slot.className]?.[slot.periodIndex];
        return { ...slot, substitute };
    }).sort((a, b) => a.periodIndex - b.periodIndex);

    let planTableHTML = '';
    if (plan.length > 0) {
        const tableRows = plan.map(slot => `
            <tr>
                <td>${periodHeaders[slot.periodIndex].name}</td>
                <td>${slot.className}</td>
                <td>${slot.subject}</td>
                <td style="color: var(--red-600);">${slot.originalTeacher}</td>
                <td><span class="substitute">${slot.substitute || '--'}</span></td>
            </tr>
        `).join('');

        planTableHTML = `
            <div style="margin-top: 2rem;">
                <div id="substitution-plan-content">
                    <h3 style="text-align: center; margin-bottom: 1rem; font-size: 1.25rem;">
                        üìã Substitution Plan: ${day}
                    </h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Class</th>
                                    <th>Subject</th>
                                    <th>Original Teacher</th>
                                    <th>Substitute</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>
                <div class="flex justify-center gap-4" style="margin-top: 1.5rem;">
                    <button onclick="handlePrint()" class="button button-secondary" style="max-width: 200px;">
                        <i data-lucide="printer"></i> Print
                    </button>
                    <button onclick="handleShareScreenshot()" class="button button-whatsapp" style="max-width: 200px;">
                        <i data-lucide="share-2"></i> Share
                    </button>
                </div>
            </div>
        `;
    }

    const html = `
        <div class="card">
            <div class="grid grid-cols-1 grid-cols-md-2 gap-6">
                <div>
                    <label class="block font-bold mb-2">1. Select Day</label>
                    <select id="sub-day-select" onchange="handleSubDayChange(this.value)">
                        ${dayOptions}
                    </select>
                </div>
                <div>
                    <label class="block font-bold mb-2">2. Select Absent Teachers</label>
                    <div style="border: 1px solid var(--gray-300); border-radius: var(--radius);
                                padding: 0.5rem; max-height: 15rem; overflow-y: auto;">
                        ${teacherOptionsHtml}
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 grid-cols-md-2 gap-4"
                 style="border-top: 1px solid var(--gray-200); padding-top: 1.5rem; margin-top: 1.5rem;">
                <button id="generate-plan-btn" class="button button-primary">
                    <i data-lucide="wand-2"></i> Generate Smart Plan
                </button>
                <button id="reset-plan-btn" class="button button-danger">
                    <i data-lucide="rotate-ccw"></i> Reset ${day} Plan
                </button>
            </div>
            <div id="plan-container">${planTableHTML}</div>
        </div>
    `;

    mainContent.innerHTML = html;
    attachSubstitutionEventListeners(day, absentTeachers);
    lucide.createIcons();
}

// --- EVENT HANDLERS & LOGIC ---
function attachSubstitutionEventListeners(day, absentTeachers) {
    document.getElementById('generate-plan-btn').addEventListener('click', () =>
        handleGeneratePlan(day, absentTeachers));
    document.getElementById('reset-plan-btn').addEventListener('click', () =>
        handleResetPlan(day));
}

function handleSubDayChange(newDay) {
    const selectedCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
    const absentTeachers = selectedCheckboxes.map(cb => cb.value);
    renderSubstitutionView(newDay, absentTeachers);
}

function handleAbsentTeacherChange(checkbox) {
    const day = document.getElementById('sub-day-select').value;
    const selectedCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
    const absentTeachers = selectedCheckboxes.map(cb => cb.value);
    renderSubstitutionView(day, absentTeachers);
}

function calculateDailyWorkload(teacher, day, currentSubs) {
    let count = 0;
    const schedule = state.allData.teacherDetails[teacher]?.schedule[day];
    if (schedule) {
        count += schedule.filter(p => p !== null).length;
    }
    Object.values(currentSubs).forEach(classSub => {
        Object.values(classSub).forEach(subTeacher => {
            if (subTeacher === teacher) count++;
        });
    });
    return count;
}

function findFreeTeachers(day, periodIndex, absentTeachers, currentDaySubs) {
    const free = [];
    for (const teacher of state.allData.teacherNames) {
        if (absentTeachers.includes(teacher)) continue;
        if (teacher === 'Gyan' || teacher === 'Phy') continue;
        if (teacher === 'Anjana' && periodIndex < 4) continue;

        if (state.allData.teacherDetails[teacher]?.schedule[day]?.[periodIndex]) continue;

        let isBusyAsSub = false;
        for (const cName in currentDaySubs) {
            if (currentDaySubs[cName][periodIndex] === teacher) {
                isBusyAsSub = true;
                break;
            }
        }
        if (isBusyAsSub) continue;

        free.push(teacher);
    }
    return free;
}

function handleGeneratePlan(day, absentTeachers) {
    if (absentTeachers.length === 0) {
        showToast("‚ö†Ô∏è Please select at least one absent teacher.");
        return;
    }

    const { teacherDetails } = state.allData;
    const vacantSlots = [];

    absentTeachers.forEach(absentTeacher => {
        const schedule = teacherDetails[absentTeacher]?.schedule[day];
        if (schedule) {
            schedule.forEach((period, periodIndex) => {
                if (period) {
                    vacantSlots.push({ ...period, periodIndex, originalTeacher: absentTeacher });
                }
            });
        }
    });

    const newDaySubstitutions = {};

    vacantSlots.sort((a,b) => a.periodIndex - b.periodIndex).forEach(slot => {
        let freeTeachers = findFreeTeachers(day, slot.periodIndex, absentTeachers, newDaySubstitutions);

        if (freeTeachers.length > 0) {
            // Smart sorting: prioritize same subject, then lowest workload
            freeTeachers.sort((a, b) => {
                const workloadA = calculateDailyWorkload(a, day, newDaySubstitutions);
                const workloadB = calculateDailyWorkload(b, day, newDaySubstitutions);
                const isSameSubjectA = teacherDetails[a].subjects.has(slot.subject);
                const isSameSubjectB = teacherDetails[b].subjects.has(slot.subject);

                if (isSameSubjectA && !isSameSubjectB) return -1;
                if (!isSameSubjectA && isSameSubjectB) return 1;
                return workloadA - workloadB;
            });

            const substitute = freeTeachers[0];
            if (!newDaySubstitutions[slot.className]) {
                newDaySubstitutions[slot.className] = {};
            }
            newDaySubstitutions[slot.className][slot.periodIndex] = substitute;
        }
    });

    state.substitutions[day] = { plan: newDaySubstitutions, timestamp: Date.now() };
    renderSubstitutionView(day, absentTeachers);
    showToast("‚úÖ Substitution plan generated successfully!");
}

function handleResetPlan(day) {
    delete state.substitutions[day];
    renderSubstitutionView(day, []);
    showToast("üîÑ Plan reset successfully!");
}

function preparePrintContent() {
    let contentToPrint;
    if (state.currentView === 'Substitution') {
        contentToPrint = document.getElementById('substitution-plan-content');
    } else if (mainContent.querySelector('.table-container')) {
        const cardClone = mainContent.querySelector('.card').cloneNode(true);
        cardClone.querySelectorAll('button, select, .flex-wrap.gap-2').forEach(el => el.remove());
        contentToPrint = cardClone;
    }

    if (contentToPrint) {
        document.getElementById('print-content').innerHTML = contentToPrint.innerHTML;
        return true;
    }
    return false;
}

function handlePrint() {
    if (preparePrintContent()) {
        window.print();
    } else {
        showToast("‚ö†Ô∏è No printable content available for this view.");
    }
}

async function handleShareScreenshot() {
    if (!preparePrintContent()) {
        showToast("‚ö†Ô∏è No content to share for this view.");
        return;
    }

    showToast("üì∏ Generating image...");

    const captureElement = document.getElementById('print-capture-area');
    captureElement.style.display = 'block';

    try {
        const canvas = await html2canvas(captureElement, {
            scale: 2,
            backgroundColor: '#ffffff',
            width: 1200,
            windowWidth: 1200
        });

        const dataUrl = canvas.toDataURL('image/png');
        const blob = await (await fetch(dataUrl)).blob();
        const file = new File([blob], 'timetable-plan.png', { type: 'image/png' });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
                files: [file],
                title: document.getElementById('print-header-subtitle').textContent,
                text: 'Timetable plan from Veer Patta Public School',
            });
            showToast("‚úÖ Image shared successfully!");
        } else {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = 'timetable-plan.png';
            link.click();
            showToast("‚úÖ Image downloaded successfully!");
        }
    } catch (error) {
        console.error("Screenshot failed:", error);
        showToast("‚ùå Could not generate image.");
    } finally {
        captureElement.style.display = 'none';
    }
}

// --- APP INITIALIZATION & NAVIGATION ---
function switchView(view) {
    state.currentView = view;
    document.querySelectorAll('nav .nav-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`nav-${view}`).classList.add('active');

    switch(view) {
        case 'Dashboard': renderDashboard(); break;
        case 'Day': renderDayView(); break;
        case 'Class': renderClassView(); break;
        case 'Teacher': renderTeacherView(); break;
        case 'Substitution': renderSubstitutionView(); break;
        default: renderDashboard();
    }

    lucide.createIcons();
    scrollToTop();
}

function init() {
    state.allData = parseTimetableData();
    switchView('Dashboard');

    const loader = document.getElementById('loader');
    loader.style.opacity = '0';
    setTimeout(() => {
        loader.style.display = 'none';
    }, 300);
}

// Initialize the application
window.onload = init;
</script>
</body>
</html>
